<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Anubis, the banking trojan :: rxOred&#39;s blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="reverse engineering the notorious android banking trojan" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://rxOred.github.io/post/analysis/anubis/anubis/" />




<link rel="stylesheet" href="https://rxOred.github.io/assets/style.css">

  <link rel="stylesheet" href="https://rxOred.github.io/assets/red.css">






<link rel="apple-touch-icon" href="https://rxOred.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://rxOred.github.io/favicon.ico">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Anubis, the banking trojan">
<meta property="og:description" content="reverse engineering the notorious android banking trojan" />
<meta property="og:url" content="https://rxOred.github.io/post/analysis/anubis/anubis/" />
<meta property="og:site_name" content="rxOred&#39;s blog" />

  <meta property="og:image" content="https://rxOred.github.io/img/anubis/anubis.jpg">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-12-13 11:50:35 &#43;0000 UTC" />












</head>
<body class="red">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    rxOred&#39;s blog
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://rxOred.github.io/post/analysis/anubis/anubis/">Anubis, the banking trojan</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-12-13
        
      </span>
    
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://rxOred.github.io/tags/reverse-engineering/">reverse-engineering</a>&nbsp;
    
    #<a href="https://rxOred.github.io/tags/android/">android</a>&nbsp;
    
    #<a href="https://rxOred.github.io/tags/malware/">malware</a>&nbsp;
    
  </span>
  
  
  <img src="https://rxOred.github.io/img/anubis/anubis.jpg"
    class="post-cover"
    alt="Anubis, the banking trojan"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <h1 id="samples">Samples<a href="#samples" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><a href="https://github.com/sk3ptre/AndroidMalware_2020/blob/master/anubis.zip">github</a></p>
<h1 id="environment">Environment<a href="#environment" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<pre><code>- linux host
- android vm (API version 23) (no google services)
</code></pre>
<h1 id="tools">Tools<a href="#tools" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<pre><code>- apktool
- adb
- frida
- mobsf
- jd-gui
</code></pre>
<h1 id="setting-things-up">Setting things up<a href="#setting-things-up" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>First of all, finding the SDK version is essential to continue dynamic analysis. This can be extracted from AndroidManifest.xml.</p>
<p><img src="/img/anubis/anubis_apktool.png" alt="extracting with apktool"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; standalone=&#34;no&#34;?&gt;</span><span style="color:#f92672">&lt;manifest</span> <span style="color:#a6e22e">xmlns:android=</span><span style="color:#e6db74">&#34;http://schemas.android.com/apk/res/android&#34;</span> <span style="color:#a6e22e">android:compileSdkVersion=</span><span style="color:#e6db74">&#34;23&#34;</span> <span style="color:#a6e22e">android:compileSdkVersionCodename=</span><span style="color:#e6db74">&#34;6.0-2438415&#34;</span> <span style="color:#a6e22e">package=</span><span style="color:#e6db74">&#34;wocwvy.czyxoxmbauu.slsa&#34;</span> <span style="color:#a6e22e">platformBuildVersionCode=</span><span style="color:#e6db74">&#34;23&#34;</span> <span style="color:#a6e22e">platformBuildVersionName=</span><span style="color:#e6db74">&#34;6.0-2438415&#34;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>as it is shown, the SDK version is 23.</p>
<p>However, since frida will be used in dynamic analysis, it is easier to use
an image without Google services. (because root access can be easily gained
in those images + running frida without root access is pain in the ass work)</p>
<p><img src="/img/anubis/anubis_newemulator.png" alt="installing a new emulator"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rxOred-aspiree :: Analysis/android/anubis » adb shell
root@generic_x86_64:/ <span style="color:#75715e"># </span>

</code></pre></div><p>Now it is straight forward to install frida on the device. Im not going to
do that here.</p>
<h1 id="analysis">Analysis<a href="#analysis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h1 id="permissions">Permissions<a href="#permissions" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.ACCESS_FINE_LOCATION&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.GET_TASKS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.RECEIVE_SMS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.READ_SMS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.WRITE_SMS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.PACKAGE_USAGE_STATS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.SYSTEM_ALERT_WINDOW&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.ACCESS_NETWORK_STATE&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.CALL_PHONE&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.INTERNET&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.SEND_SMS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.WRITE_EXTERNAL_STORAGE&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.READ_EXTERNAL_STORAGE&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.RECORD_AUDIO&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.READ_CONTACTS&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.READ_PHONE_STATE&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.WAKE_LOCK&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.RECEIVE_BOOT_COMPLETED&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;uses-permission</span> <span style="color:#a6e22e">android:name=</span><span style="color:#e6db74">&#34;android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>As we can see, this malware can send, recieve SMS, read contacts, access location, read and write
to external storage. It is also requesting permission to get notified once when the system boots
up.</p>
<p><img src="/img/anubis/anubis_androgaurd.png" alt="androguard results"></p>
<p>here we can see that the application has 17 activities.</p>
<p><img src="/img/anubis/anubis_androguard.png" alt="androguard results"></p>
<p>here androguard shows us recievers, main activity and the services.</p>
<p>However all the above stuff are obfuscated.</p>
<p>Lets try to identify the obfuscator by analyzing the smali code.</p>
<h1 id="identifying-the-obfuscator">Identifying the obfuscator<a href="#identifying-the-obfuscator" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>It is possible to identify the obfuscator just by looking at smali code. For example, ProGuard,
which is one of the most popular android obfuscators out there, can be idenitified if the smali
code contains variable names, strings with <code>a</code>, <code>a;-&gt;a</code> characters. (However ProGuard accepts different sets of characters for this, and it is not a good idea to make decision just based ont this).</p>
<p>first lets check for DexGuard, another common obfuscator. DexGuard is known to use non ascii
chars for obfuscation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> re<span style="color:#f92672">,</span> os
<span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">non_ascii_in_string</span>(string):
    regexp <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;[^\00-\xff]&#39;</span>)
    <span style="color:#66d9ef">if</span> regexp<span style="color:#f92672">.</span>search(string):
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scan_file</span>(filepath):
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">with</span> open(filepath, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f: 
            i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
            <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f:
                i<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>
                <span style="color:#66d9ef">if</span> non_ascii_in_string(line):
                    print <span style="color:#e6db74">&#34;line [</span><span style="color:#e6db74">{lno}</span><span style="color:#e6db74">] </span><span style="color:#e6db74">{line}</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">{file}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(lno<span style="color:#f92672">=</span>i, line<span style="color:#f92672">=</span>line, file<span style="color:#f92672">=</span>filepath)
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    pathlist <span style="color:#f92672">=</span> Path(<span style="color:#e6db74">&#34;smali&#34;</span>)<span style="color:#f92672">.</span>rglob(<span style="color:#e6db74">&#34;*.smali&#34;</span>)
    <span style="color:#66d9ef">for</span> path <span style="color:#f92672">in</span> pathlist:
        scan_file(str(path))

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><p>above python script scans the smali directory generated by apktool for strings that contain non
ascii characters.</p>
<p><img src="/img/anubis/anubis_notdexguard.png" alt="DexGuard detection"></p>
<p>so its no harm to conclude that this sample is not obfuscated with DexGuard.</p>
<p>we can use the same script to detect ProGuard by replacing the regular expression with <code>a/a;-&gt;a</code>.</p>
<p>here is the result.</p>
<p><img src="/img/anubis/anubis_proguard.png" alt="detecting obfuscation"></p>
<p>from that, we can conclude that this sample is obfuscated using ProGuard.</p>
<p>Thing only makes things worse because, as far as im aware of, there is no way we can rename the
variables, classes and methods without the mapping file.</p>
<h1 id="automated-analysis-with-mobsf">Automated analysis with MobSf<a href="#automated-analysis-with-mobsf" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Now we have a very basic idea of what malware is capable of, its time for some dynamic analysis</p>
<p>before running the sample on the vm, it wwould be better to run it on a automated framework. Then
we can focus on the specific details. Here im going to use MobSF.</p>
<p><img src="/img/anubis/anubis_mobsf.png" alt="automated analysis"></p>
<p><img src="/img/anubis/anubis_mobsfstatic.png" alt="mobsf results"></p>
<p>with the above result, we can confirm our assumptions on receivers, activities and services we made
considering the result of androguard.</p>
<p>MobSF also provides us with some other useful information like, which activities, services use
which APIs, which classes makes use of requested permissions and so on.</p>
<p><img src="/img/anubis/anubis_mobsfapi.png" alt="apis"></p>
<p>However when i try to run a dynamic analysis on the apk, MobSF failed with few errors.</p>
<h1 id="dynamic-analysis">Dynamic analysis<a href="#dynamic-analysis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>first, im going to stop the emulator and restart it with following parameters</p>
<p><code>-show-kernel -tcpdump dump.cap</code></p>
<p>so we can take a look at network traffic later on, in case. (I&rsquo;ve also setup mitmproxy)</p>
<p><img src="/img/anubis/anubis_installapk.png" alt="installing the malware"></p>
<p>running the sample, its asking to enable &lsquo;accessibility permissions&rsquo;. And the user is forced to grant the permission. This enables application run in the background.</p>
<p><img src="/img/anubis/anubis_accessibilities.png" alt="accessibility permissions"></p>
<p>Here&rsquo;s the network traffic.</p>
<p><img src="/img/anubis/anubis_requeststorandom.png" alt="network traffic"></p>
<p><img src="/img/anubis/anubis_request.png" alt="request"></p>
<p>when granted the requested permission, the malware seemed to be deleted from the devic.
However, its listed in the packages.</p>
<pre tabindex="0"><code>root@generic_x86_64:/ # pm list packages | grep slsa                           
package:wocwvy.czyxoxmbauu.slsa
root@generic_x86_64:/ # 
</code></pre><p>which means that it has only deleted the icon from the application launcher not
the app itself.</p>
<h1 id="diving-deep">Diving deep<a href="#diving-deep" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://rxOred.github.io/post/analysis/simplelocker/simplelocker/">
                <span class="button__text">Simplelocker, an android ransomware</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://rxOred.github.io/assets/main.js"></script>
<script src="https://rxOred.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
